%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}


%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{POPL} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2023}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
\citestyle{acmauthoryear}   %% For author/year citations

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Some recommended packages.
\usepackage[utf8]{inputenc}
\usepackage[british]{babel}
\usepackage[hyperpageref]{backref}
\usepackage[capitalise,noabbrev]{cleveref}
\usepackage{xifthen,xspace}
\usepackage[color=yellow,textsize=footnotesize,prependcaption,obeyFinal]{todonotes}
\usepackage[inline]{enumitem} % for environment enumerate*
%\definecolor{addition}{RGB}{204,255,216}
%\usepackage{subcaption}
\usepackage{bussproofs}
\EnableBpAbbreviations
\usepackage[all,cmtip]{xy}
%\CompileMatrices

%\usepackage{mathtools}
%\usepackage[euler]{textgreek}

\usepackage{newunicodechar}

%% citation 
\newcommand{\varcitet}[3][]{\citeauthor{#2}#3~[\ifthenelse{\isempty{#1}}{\citeyear{#2}}{\citeyear[#1]{#2}}]}
\newcommand{\NoPeriod}[1]{\,}
\newcommand{\arXiv}[1]{\href{http://arxiv.org/abs/#1}{arXiv:\nolinkurl{#1}}}

%% set up unicode symbols
\newunicodechar{δ}{\ensuremath{\delta}}
\newunicodechar{ƛ}{\ensuremath{\lambdabar}}
\newunicodechar{Λ}{\ensuremath{\Lambda}}
\newunicodechar{⁺}{\ensuremath{{}^+}}

%% set up todonotes
\setlength {\marginparwidth }{2cm}
\newcommand{\LT}[2][]{%
  \ifthenelse{\isempty{#1}}%
  {\todo[author=LT,inline]{#2}}%
  {\todo[author=LT,inline,caption={#1}]{#2}}%
}
\newcommand{\Josh}[2][]{%
  \ifthenelse{\isempty{#1}}%
  {\todo[author=Josh,inline]{#2}}%
  {\todo[author=Josh,inline,caption={#1}]{#2}}%
}

 
\AtEndPreamble{%
 \theoremstyle{acmdefinition}
 \newtheorem{remark}[theorem]{Remark}
 \newtheorem{fact}[theorem]{Fact}
 \newtheorem*{remark*}{Remark}
}

\input{macros.tex}

\begin{document}

\title{From Binding Signature to Bidirectional Type Checking}
\author{Liang-Ting Chen}
\email{liang.ting.chen.tw@gmail.com}
\orcid{0000-0002-3250-1331}
\author{Hsiang-Shang Ko}
\email{joshko@iis.sinica.edu.tw}
\orcid{0000-0002-2439-1048}
\affiliation{%
  \department{Institute of Information Science}
  \institution{Academia Sinica}
  \streetaddress{128 Academia Road, Section 2, Nankang}
  \city{Taipei}
  \country{Taiwan}
  \postcode{115201}
}
\begin{abstract}


\end{abstract}

%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
   <concept>
       <concept_id>10011007.10011006.10011039.10011040</concept_id>
       <concept_desc>Software and its engineering~Syntax</concept_desc>
       <concept_significance>500</concept_significance>
       </concept>
   <concept>
       <concept_id>10011007.10011006.10011008.10011024.10011028</concept_id>
       <concept_desc>Software and its engineering~Data types and structures</concept_desc>
       <concept_significance>300</concept_significance>
       </concept>
 </ccs2012>
\end{CCSXML}
\ccsdesc[500]{Software and its engineering~Syntax}
\ccsdesc[300]{Software and its engineering~Data types and structures}
%% End of generated code

\keywords{abstract syntax, binding signature, $F$-algebra, bidirectional type checking}
%% \keywords are mandatory in final camera-ready submission

\maketitle

\todototoc
\listoftodos[List of Todos]\\

\section{Introduction}
Context cannot be finite if we consider the transformation from an abstract syntax where the type of identifiers is not finite.

\subsection{Related Work}

\paragraph{Formal theory of abstract syntax with binding} \citep{Altenkirch1999a,Fiore1999,Fiore2008,Matthes2004,Tanaka2006,Ahrens2018b,Ahrens2018}
\paragraph{Formalisation and implementation} \citep{Allais2018,Allais2021}\citep{Ahrens2022}\citep{Fiore2022}
\paragraph{Bidirectional typing} \citep{Dunfield2021}

\subsection{Synopsis and Contributions}

\section{Mathematical Foundations of Substitution}
We assume the reader is familiar with basic category theory such as category, functor, natural transformation, limit, monad, and monoidal category in the classic textbook by \citet{MacLane1978}. 

\paragraph{Terminology} A \emph{monad} in this paper refers to a \emph{functor} $T\colon \catC \to \catC$ with two natural transformations $\eta\colon \Id \to T$ and $\mu\colon T\fcomp T \to T$ satisfying monad laws.
An equivalent notion is \emph{Kleisli triple} which refers to a \emph{function} $T\colon \Obj{\catC} \to \Obj{\catC}$, a morphism $\eta_X \colon X \to T X$ for $X \in \Obj{X}$ and $\subst{f} \colon T X \to TY$ for $f\colon X \to Y$, satisfying monad laws.
The natural transformations $\eta$, $\mu$, and the mapping $(\blank)^\star$ are called \texttt{return}, \texttt{join}, and \texttt{bind} (with its two arguments flipped), for $T$ being strong, respectively in functional programming.


\subsection{Prelude: \texorpdfstring{$F$}{F}-Algebra and Initial Semantics}

In this section, we start with a recap of initial semantics using $F$-algebras, also fixing our notations.
Examples are carefully walked through to motivate our definitions and later developments.

\begin{definition}
  An algebra $(A, \alpha)$ for an endofunctor $F\colon \catC \to \catC$ is an object $A$ of $\catC$ and a morphism $\alpha \colon FA \to A$ where $A$ is called the \emph{carrier} and $\alpha$ the \emph{structure map}
  of the algebra, and $F$ the \emph{signature} functor. 
  An $F$-homomorphism from $(A, \alpha)$ to $(B, \beta)$ is a morphism $f\colon A \to B$ satisfying $f \comp \alpha = \beta \comp Ff$.
  The category of $F$-algebras and $F$-homomorphisms is denoted by $\mathsf{Alg}(F)$. 
\end{definition}
One simplistic example for signature functor is $(\Unit + \blank)\colon \set \to \set$ which maps any set $X$ to the coproduct the disjoint union $\Unit + X$ of the singleton $\Unit$ and $X$ and a function $f\colon X \to Y$ to $\idfunc[\Unit] + f$ defined as the mediating function $[\inl_{\Unit, X} \circ \idfunc[\Unit], \inr_{\Unit, X} \circ f]\colon \Unit + X \to \Unit + Y$ where $\inl_{1, X}$ (and $\inr_{1, X}$) is the left (and right) injection to the coproduct. 
For brevity, we follow the convention that $\idfunc[\Unit] + f$ is denoted $\Unit + f$.
The functoriality of $\Unit + (\blank)$ can be verified directly, or derived \emph{compositionally}, following from that (co-)limits of functors from $\catD$ to $\catC$ are calculated pointwise in~$\catC$ provided the pointwise (co-)limits exist.
That is, $\Unit + (\blank)$ is the coproduct of the constant functor $\underline{\Unit_{\set}}$ and the identity functor~$\Id[\set]$.
Since $\Unit$ is a singleton, $\alpha_1$ is viewed interchangeably as its value $\alpha_1(\ttt)$. 

The structural map of a $(\Unit + \blank)$-algebra $(A, \alpha)$ is equal to the mediating morphism $[\alpha_1, \alpha_2]$ of $\alpha_1 = \alpha \comp \inl_{\Unit, A}$ and $\alpha_2 = \alpha \comp \inr_{\Unit, A} \colon A \to A$.
Hence, a $(\Unit + \blank)$-algebra can be regarded equivalently as a triple $(A, \alpha_1, \alpha_2)$. 
For example, the set $\Nat$ of natural numbers with the constant $0$ and the successor function $s\colon \Nat \to \Nat$ forms an $F$-algebra $(\Nat, [\underline{0}, s])$.
Moreover, this algebra $(\Nat, [\underline{0}, s])$ is initial:
For every $(\Unit + \blank)$-algebra $(A, \alpha)$, there is a unique homomorphism $f\colon (\Nat, [\underline{0}, s]) \to (A, \alpha)$.
Equivalently, every triple $(A, \underline{z}, \alpha_2)$ associates with
a unique function $f\colon \Nat \to A$ such that $f(0) = z$ and $f(s(n)) = \alpha_2 (f(n))$, modelling the structural recursion over the inductive type $\Nat$.
In terms of functional programming, this is exactly $\mathtt{fold}_{\Nat}\colon A \to (A \to A) \to \Nat \to A$ for natural numbers.

The next is one of our leading example: \citet{Bird1999}'s formulation of $\lambda$-terms as a nested type.
\begin{example}\label{ex:untyped-lambda-calculus}
  Define $\lambda$-terms up to $\alpha$-equivalence over an \emph{arbitrary} set $X$ of variables by
\begin{figure}[H]
  \begin{minipage}[b]{.3\textwidth}
    \begin{prooftree}
      \AXC{$x \in X$}
      \RightLabel{$(\mathsf{var})$}
      \UIC{$`x \in \Lambda X$}
    \end{prooftree}
  \end{minipage}
  \begin{minipage}[b]{.3\textwidth}
    \begin{prooftree}
      \AXC{$t \in \Lambda X$}
      \AXC{$u \in \Lambda X$}
      \RightLabel{$(\mathsf{app})$}
      \BIC{$t \cdot u \in \Lambda X$}
    \end{prooftree}
  \end{minipage}
  \begin{minipage}[b]{.3\textwidth}
    \begin{prooftree}
      \AXC{$t \in \Lambda (\Unit + X)$}
      \RightLabel{$(\mathsf{abs})$}
      \UIC{$\lambda t \in \Lambda X$}
    \end{prooftree}
  \end{minipage}
%  \caption{Untyped lambda terms up to $\alpha$-equivalence}
%  \label{fig:lambda-calculus}
\end{figure}%
\noindent also a function named after each rule---$\mathsf{var}_X(x) = `x$, $\mathsf{app}_X(t, u) = t \cdot u$, and $\mathsf{abs}_{X}(t) = \lambda\,t$.
  This formulation is a variant of \emph{de Bruijn representation} in the sense each bound variable in $t \in \Lambda X$ is of the form $(\inr^n \circ \inl)(\ttt) \in \Unit + (\cdots + (\Unit + X))$ for some natural number $n$;
  free variables are $\inr^{n+1}(x)$ for some $x$ in $X$.
  For brevity, we denote $\inl_{\Unit, X}(\ttt)$ and $\inr_{\Unit, X} \colon X \to \Unit + X$ by $z_X$ and $s_X$ respectively, e.g.,\ $\lambda\,\lambda `s(z)$ is the first projection (where the subscripts are omitted).
  This formulation resembles the \emph{locally nameless representation} by \citet{Chargueraud2012} where bound variables are represented by de Bruijn indices but free variables, introduced by a separate rule, are from another set.

  Simultaneous renaming $\Lambda\rho\colon \Lambda X \to \Lambda Y$ for a renaming rule  $\rho\colon X \to Y$  
  defined by
  \begin{align*}
    \Lambda\rho (x) & =  `\rho(x) & \Lambda\rho (t \cdot u)  & =  \Lambda\rho(t) \cdot \Lambda\rho(u) & \Lambda\rho (\lambda\,t) & =  \lambda\left(\Lambda(\Unit + \rho)(t)\right)
  \end{align*}
  replaces variables $x \in X$ by $\rho(x)$ but leaves bound variables intact, illustrating three diagrams
  \[
    \xymatrix@C+1em@R-1em{
      X \ar[r]^-{\mathsf{var}_X} \ar[d]_{\rho} & \Lambda X \ar[d]^{\Lambda(\rho)} \\
      Y \ar[r]_-{\mathsf{var}_Y} & \Lambda Y 
    }
    \qquad
    \xymatrix@C+1em@R-1em{
      \Lambda X\times\Lambda X \ar[r]^-{\mathsf{app}_X} \ar[d]_{\Lambda\rho \times \Lambda\rho} & \Lambda X \ar[d]^{\Lambda\rho} \\
      \Lambda Y\times\Lambda Y \ar[r]_-{\mathsf{app}_Y} & \Lambda Y 
    }
    \qquad
    \xymatrix@C+1em@R-1em{
      \Lambda(\Unit + X) \ar[r]^-{\mathsf{abs}_X} \ar[d]_{\Lambda(\Unit + \rho)} & \Lambda X \ar[d]^{\Lambda\rho} \\
      \Lambda(\Unit + Y) \ar[r]_-{\mathsf{abs}_Y} & \Lambda Y
    }
  \]
  where $\Lambda(\Unit + X)$ is the composed functor $\Lambda \fcomp (\Unit + \blank)$ applied to $X$.
  It is straightforward to check that with renaming $\Lambda\colon\set\to\set$ forms a functor, i.e.
  \[
    \Lambda\rho(\idfunc[X]) = \idfunc[\Lambda X] \quad\text{and}\quad \Lambda(\rho_2 \comp \rho_1)  = \Lambda\rho_2 \comp \Lambda\rho_1
  \]
  for any $\rho_1\colon X \to Y$ and $\rho_2\colon Y \to Z$.
  Therefore, each family of functions above is a natural transformation to $\Lambda$. 
  Moreover, each construct can be seen as an algebra for a suitable endofunctor:
  \begin{enumerate*}
    \item the constant functor $\underline{\Id[\set]}$, 
    \item the product $\Id \times \Id$, and
    \item the (context) extension $\delta$ defined by $\delta T \defid T \fcomp (\Unit + \blank)$ and $\delta\tau \defid \tau \fcomp (\Unit + \blank)$ for $\tau \colon T \to T'$, respectively.
  \end{enumerate*}
  In short, the three constructs of $\lambda$-terms exhibit an algebra structure on $\Lambda$:
  \[
    [\mathsf{var}, \mathsf{app}, \mathsf{abs}] \colon \Lambda + \LC(\Lambda) \to \Lambda
  \]
  for the endofunctor $\underline{\Id} + \LC$ of $\Endo{\set}$ where $\LC \defid \Id \times \Id + \delta$.
  This algebra is even the \emph{initial} algebra, as we will show later .
\end{example}

\begin{remark*}
We do not require the context set $X$ being finite or, in particular, a list of variables to make sense of context operations, contrast to the frameworks proposed by \citet{Fiore1999,Allais2021}.
For example, the \emph{weakening} operation is (still) defined solely via functorality and the injection $s \colon X \to \Unit + X$
\begin{align}\label{eq:weakening}
  \Lambda s      \colon \Lambda X \to \Lambda(\Unit + X)
\end{align}
where each variable $x$ in $t \in \Lambda X$ is `shifted' to $s(x)$, resulting a term $\Lambda s(t)$ in the context $\Unit + X$.
  
\end{remark*}


Formulating $\lambda$-terms as an algebra would be useless if this was the only algebra for $(\underline{\Id} + \LC)$.
Indeed, there are other examples and such an algebra needs not be syntactic at all.
\begin{example}\label{ex:free-variables}
  The set $\fv_X(t)$ of free variables in $t \in \Lambda X$ is defined for arbitrary $X$ by
  \begin{align*}
    \fv_X(`x) & = \{x\} & \fv_X(t \cdot u) & = \fv_X(t) \cup \fv_X(u) & \fv_X(\lambda\,t) = \fv_{\Unit + X}(t) \cap X
  \end{align*}
  Put differently, the definition of $\fv_X$ can be illustrated by three commutative diagrams 
  \begin{equation}\label{eq:free-variables}
    \vcenter{
    \xymatrix@C+1em@R-1em{
      X \ar[r]^-{\mathsf{var}_X} \ar[d]_{\idfunc} & \Lambda X \ar[d]^{\fv_X} \\
      X \ar[r]_-{\{\blank\}_X} & \power X 
    }}
    \qquad
    \vcenter{
    \xymatrix@C+1em@R-1em{
      \Lambda X\times\Lambda X \ar[r]^-{\mathsf{app}_X} \ar[d]_{\fv_X \times \fv_X} & \Lambda X \ar[d]^{\fv_X} \\
      \power X\times\power X \ar[r]_-{\blank \cup_X \blank} & \power X 
    }}
    \qquad
    \vcenter{
    \xymatrix@C+1em@R-1em{
      \Lambda(\Unit + X) \ar[r]^-{\mathsf{abs}_X} \ar[d]_{\fv_{\Unit +X}} & \Lambda X \ar[d]^{\fv_X} \\
      \power(\Unit + X) \ar[r]_-{\blank \cap X} & \power X 
    }}
  \end{equation}
  where $\power$ is the powerset functor and metaphorically $(\blank)\cap X$ strengthens indices in $S \in \power(\Unit + X)$ by removing $z_X$ and decrementing $s_X(x)$ to $x$.
  We can readily check that functions of the lower legs in~\eqref{eq:free-variables} are natural in $X$, forming a $(\underline{\Id} + \LC)$-algebra on the functor $\power$. 
  Renaming variables does not make a free variable bound or vice versa, so $\power\rho  \comp \fv_X = \fv_Y \comp \Lambda\rho$ holds for any $\rho$, showing that $\fv_X\colon \Lambda X \to \power X$ is natural in~$X$.
  Thus, by \eqref{eq:free-variables}, the natural transformation $\fv$ is a homomorphism.
  Indeed, this is the unique $\LC$-homomorphism from $(\Lambda, [\mathsf{var}, \mathsf{app}, \mathsf{abs}])$ as shown later.
\end{example}

We may wonder if \emph{simultaneous substitution} $\subst{\sigma}\colon \Lambda X \to \Lambda Y$ for a substitution rule $\sigma\colon X \to \Lambda Y$ is a homomorphism.
However, $\subst{\sigma}(x) = \sigma(x)$ is not necessarily a variable, so it is not homomorphic.
\subsection{Algebra with Substitution}\label{sec:algebra-with-substitution}
In this section, we extend algebras by substitution that is compatible with its algebra structure. 
Simultaneous substitution $\subst{\sigma}\colon \Lambda X \to \Lambda Y$ for a substitution rule $\sigma\colon X \to \Lambda Y$ is defined by
\begin{align*}
  \subst{\sigma}`x & = \sigma(x)  & \subst{\sigma}(t \cdot u) & = \subst{\sigma}t \cdot \subst{\sigma}u
                     &  \subst{\sigma}\lambda\,t & = \lambda \subst{[\mathsf{var}_{\Unit + Y} \circ \underline{z_Y}, \Lambda s \circ \sigma]}t
\end{align*}
where the substitution rule $[\mathsf{var}_{\Unit + Y} \comp \underline{z_Y}, \Lambda s \circ \sigma]$ in the third rule amounts to two functions
\[
  \mathsf{var}_{1 + Y} \circ \underline{z_Y} \colon \Unit \to \Lambda(\Unit + Y)
  \quad\text{and}\quad
  \Lambda s \circ \sigma \colon X \to \Lambda(\Unit + Y)
\]
specifying that the variable $z$ bound to $\lambda$ remains the same and every other variable $x \in X$ is replaced by $\sigma(x)$ but weakened using \eqref{eq:weakening}. 
It is is well-known \citep{Altenkirch1999a} that $(\Lambda, \mathsf{var}, \subst{\blank})$ forms a Kleisli triple, so
by the equivalence between Kleisli triple and monad, substitution $\subst{\sigma}$ boils down to---$\mu_Y \comp \Lambda \sigma$ with $\mu_Y = \subst{\idfunc[TY]}$---simultaneous renaming for the rule $\sigma$ followed by flattening a $\lambda$-term over $\lambda$-terms.
It turns out that $\subst{[\mathsf{var}_{\Unit + Y}\comp \underline{z_Y}, \Lambda s \circ \sigma]}$ decomposes into
\begin{align*}
      & \mu_{\Unit + Y} \comp \Lambda[\mathsf{var} \circ \underline{z}, \Lambda s \circ \sigma] \\
  ={} & \mu_{\Unit + Y} \comp {\color{red}\Lambda[\mathsf{var} \circ \underline{z}, \Lambda s]} \comp {\color{blue}\Lambda(\idfunc[\Unit] + \sigma)}
      && \{\,\text{by functorality and the `fusion law' for coproduct} \,\} \\
  ={} & (\delta\mu)_Y \comp {\color{red}\theta^{\mathsf{abs}}} \comp {\color{blue}(\delta\Lambda)\sigma}.
      && \{\,\text{by $\theta^{\mathsf{abs}} \defid \Lambda[\mathsf{var}_{\Unit + Y} \circ \underline{z_Y}, \Lambda s]$ and by the definition of $\delta$} \,\} 
\end{align*}
(with some subscripts omitted) so that the following diagram illustrates the third rule
\[
  \vcenter{
    \xymatrix@C+1em@R-1em{
      (\delta \Lambda) X \ar[r]^{\color{blue}(\delta\Lambda) \sigma} \ar[d]_{\mathsf{abs}_X} & (\delta \Lambda)\Lambda Y \ar[r]^{\color{red}\theta^{\mathsf{abs}}} \ar[d]_{\mathsf{abs}_{\Lambda Y}} &
      \left(\delta (\Lambda \fcomp \Lambda)\right) Y \ar[r]^-{(\delta\mu)_Y}& (\delta \Lambda) Y \ar[d]^{\mathsf{abs}_Y} \\
      \Lambda X \ar[r]_{\Lambda\sigma} \ar@<-.1ex> `d[r] `[rrr]_{\subst{\sigma}} [rrr] & \Lambda \Lambda Y \ar[rr]_{\mu_Y} & & \Lambda Y
    }
  }
\]
%\[
%  \vcenter{
%    \xymatrix{
%      (\Lambda \times \Lambda) X \ar[r]^-{\mathsf{app}_X} \ar[d]_{(\Lambda \times \Lambda)\sigma} & \Lambda X \ar[d]^{\Lambda\sigma} \\
%      (\Lambda\times\Lambda) \Lambda Y  \ar@{=}[d]_{\theta^{\mathsf{app}}_Y} \ar[r]^-{\mathsf{app}_{\Lambda Y}} & \Lambda\Lambda Y \ar[dd]^{\mu_Y} \\ 
%      (\Lambda \fcomp \Lambda \times \Lambda \fcomp \Lambda) Y \ar[d]_{(\mu\times\mu)_Y}&  \\ 
%      (\Lambda \times \Lambda) Y \ar[r]_{\mathsf{app}_{Y}} & \Lambda Y 
%    }
%  }
%  \quad
%  \vcenter{
%    \xymatrix{
%      (\delta \Lambda)X \ar[r]^{\mathsf{abs}_X} \ar[d]_{(\delta\Lambda)\sigma} & \Lambda X \ar[d]^{\Lambda\sigma} \\
%      (\delta \Lambda) \Lambda Y \ar[d]_{\theta^{\mathsf{abs}}_Y} \ar[r]^{\mathsf{abs}_{\Lambda Y}} &  \Lambda\Lambda Y \ar[dd]^{\mu_Y} \\ 
%      (\delta(\Lambda\fcomp \Lambda)) Y \ar[d]_{(\delta\mu)_Y} &  \\ 
%      (\delta\Lambda) Y \ar[r]_{\mathsf{abs}_{Y}} & \Lambda Y 
%    }
%  }
%\]
By examining the diagram carefully, we find that the only datum required to have substitution compatible with $\mathsf{abs}$ is $\theta^{\mathsf{abs}}$, motivating \Cref{def:strength,def:substitution-algebra}.
In order to define $\theta^{\mathsf{abs}}$ independent of $\Lambda$, we work with pointed endofunctors $(Z, e)$ representing structures with a (semantic) variable rule.
A \emph{pointed functor} consists of an endofunctor $Z$ of $\catC$ and a natural transformation $e\colon \Id \to Z$ and morphisms $f\colon (Z, e) \to (Z', e')$ between them are natural transformations $f\colon Z \to Z'$ satisfying $e' = f \comp e$.
We denote the category of pointed functors of $\catC$ by $\Pt{\catC}$ and its forgetful functor $(Z, e) \mapsto Z$ by $U\colon \Pt{\catC}\to \Endo{\catC}$.
  \begin{definition}\label{def:strength}
  A (right) \emph{strength} $\theta$ for $H\colon \Endo{\catC} \to\Endo{\catC}$ relative to $U\colon \Pt{\catC} \to \Endo{\catC}$ is a family $\theta$ of natural transformations
  \[
    \theta_{T, (Z, e)} \colon H T \fcomp Z \to H(T \fcomp Z)
  \]
  \emph{natural} in $T\colon \catC \to \catC$ and the pointed functor $(Z, e)$ such that 
  \begin{enumerate}
    \item $\theta_{T, (\Id, \idfunc)} = \idfunc[HT]$ for each $T$ and
    \item $\theta_{T, (Z' \fcomp Z, e' \fcomp e)} = \theta_{T \fcomp Z', (Z, e)} \comp \theta_{T, (Z', e')} \fcomp Z$ for any $T$ and pointed functors $(Z, e)$ and $(Z', e')$.
%      \[
%      \xymatrix@C+5em{
%        HT \fcomp (Z' \fcomp Z)
%        \ar[rr]^{\theta_{T, (Z' \fcomp Z, e' \fcomp e)}}
%        \ar@{=}[d] & & H(T \fcomp (Z' \fcomp Z)) \\
%        (HT \fcomp Z') \fcomp Z \ar[r]_{\theta_{T, (Z', e')} \fcomp Z} &  H(T \fcomp Z') \fcomp Z
%        \ar[r]_{\theta_{T\fcomp Z', (Z, e)}} & H((T \fcomp Z') \fcomp Z) \ar@{=}[u] 
%      }
%    \]
  \end{enumerate}
  For brevity, we simply call $H$ a \emph{functor with strength}, if the associated strength is clear from context.
\end{definition}
There are three naturality conditions, i.e.\ for $T$, $(Z, e)$ and objects $X$ in $\catC$, imposed on the strength but we shall not worry about checking them.
In practice, we will work with a presentation for $(H, \theta)$, called binding signatures, for a class of functors with strength so that the condition will be checked once for all.
\begin{definition}\label{def:substitution-algebra}
  An \emph{$H$-algebra with substitution} $(T, \eta, \alpha, \mu)$ consists of a monad $(T, \eta, \mu)$ and an $H$-algebra $(T, \alpha)$ satisfying
  \begin{equation}\label{dig:substitution}
    \vcenter{
      \xymatrix@C+2em{
        HT\fcomp T \ar[d]_{\alpha \fcomp T} \ar[r]^-{\theta_{T, (T, \eta)}} & H(T\fcomp T) \ar[r]^-{H\mu} & HT \ar[d]^{\alpha} \\
        T\fcomp T \ar[rr]_{\mu} & & T
      }
    }
  \end{equation}
  We may write $(T, \eta, \alpha, \blank^\star)$ for an $H$-algebra with substitution and call $\blank^\star$ \emph{(semantic) substitution} where $(T, \eta, \blank^\star)$ is the Kleisli triple in bijection with $(T, \eta, \mu)$.
\end{definition}
In other words, an $(H, \theta)$-algebra with substitution consists of a monad structure and an $H$-algebra on the same functor $T$ such that the algebra map commutes with the `semantic' substitution operation $(\blank)^\star$ in the way determined by the strength $\theta$.

\begin{remark*}
  This notion is a special case of \emph{$\Sigma$-monoids}~\citep{Fiore2008} for an endofunctor $\Sigma$ with a $(I/\catC)$-strength $\theta$ on a monoidal category~$(\catC, I, \otimes)$ defined as a $\Sigma$-algebra $(A, \alpha\colon \Sigma A \to A)$ for $A$ in $\catC$ equipped with a monoid structure $(A, \eta, \mu)$ satisfying \eqref{dig:substitution} while $\Sigma = H$ and $\catC$ is the monoidal category of endofunctors with the functor composition $\fcomp$ as the monoidal tensor $\otimes$.
\end{remark*}

Two previous examples are indeed algebras with substitution.
\begin{example}[\Cref{ex:untyped-lambda-calculus}, continued]
  Based on the discussion at the beginning of this section, define a strength $\theta^{\LC}$ for $\LC$ as the coproduct
  $\theta^{\times} + \theta^{\delta} $ of another two strengthens for $\Id \times \Id$ and $\delta$ respectively given by
  \begin{align*}
    \theta_{T, (Z, e)}^{\times} &\colon (T \times T) \fcomp Z \to TZ \times TZ  &
    \theta_{T, (Z, e)}^{\delta} &\colon \delta T \fcomp Z \to \delta (T \fcomp Z) \\
    \left(\theta_{T, (Z, e)}^{\times}\right)_Y & = \idfunc[TZY] \times \idfunc[TZY] &
    \left(\theta_{T, (Z, e)}^{\delta}\right)_Y & = T[e_{\Unit + Y} \comp \underline{z_Y}, Zs_Y].
  \end{align*}
  By instantiating $\theta^\delta$ with $\Lambda$ and $(\Lambda, \mathsf{var})$, we derive $\theta^{\mathsf{abs}}$ exactly as desired, so by construction $(\Lambda, \mathsf{var}, [\mathsf{app}, \mathsf{abs}], \subst{\blank})$ is an $\LC$-algebra with substitution.
\end{example}

\begin{example}[\Cref{ex:free-variables}, continued] \label{ex:free-variable-alg-subst}
  By instantiating $\theta$ with $\power$ and $(\power, \subset{\blank})$, the strength becomes a family of morphisms $\power[\subst{\blank} \comp \underline{z_X}, \power s]\colon \power(\Unit + \power X) \to \power^2(\Unit + X)$ natural in $X$ where 
  \[
    [\subst{\blank} \comp \underline{z_X}, \power s] \colon \Unit + \power X \to \power(\Unit + X)
  \]
  maps $z_X$ to the singleton $\{z\}$ and every subset $U \subseteq X$ to $s[U] \subseteq \Unit + X$, i.e.\ every element $x \in U$ is weakened.
  Then, it is routine to check the condition \eqref{dig:substitution}, so we omit it.
  It follows that $(\power, \{\blank\}, [\blank\cup_X\blank, \blank \cap X]_X, \bigcup)$ is indeed an $\LC$-algebra with substitution.
  %The case of $\mu^\power(U \cup V) = \mu^\power(U) \cup \mu^\power(V)$ for $U, V \in \power^2(X)$ is routine to check.
\end{example}

\subsection{Morphism of Algebra with Substitution}
We observe that the homomorphism $\fv$ satisfies a nice property called \emph{semantic substitution lemma}:
\begin{lemma}\label{lem:substitution-lemma-fv}
  Substitution for any rule $\sigma \colon X \to \Lambda Y$ commutes with $\fv$ in the sense that the diagram
  \begin{equation}\label{eq:substitution-lemma}
    \vcenter{
      \xymatrix@C+1em@R-1em{
        \Lambda X \ar[r]^{\subst{\sigma}} \ar[d]_{\fv_X} & \Lambda Y \ar[d]^{\fv_Y} \\
        \power  X \ar[r]_{\left(\fv_Y \comp \sigma\right)^\star} & \power Y
      }
    }
    \;\text{or, equivalently }\;
    \vcenter{
      \xymatrix@C+.5em@R-1em{
        \Lambda X \ar[d]_{\fv_X} \ar[r]^{\Lambda \sigma} & \Lambda \Lambda Y \ar[rr]^{\mu_Y} \ar[d]^{\fv_{\Lambda Y}} & & \Lambda Y \ar[d]^{\fv_Y} \\
        \power  X \ar[r]_{\power \sigma} & \power  \Lambda Y \ar[r]_{\power(\fv_Y)} & \power \power Y \ar[r]_{\bigcup} & \power Y
      }
    }
  \end{equation}
  commutes where $(\blank)^\star$ is the semantic substitution for the powerset monad $(\power, \{\blank\}, \bigcup)$. 
\end{lemma}
From a computational viewpoint, calculating the set $\fv_Y(\subst{\sigma} t)$ of free variables can be performed priori to substitution without building the intermediate term $\subst{\sigma}t$. 
Moreover, we only need to traverse the term $t$ once while collecting free variables $x_i$'s and compute the free variables of $\sigma(x_i)$ once even if $x_i$ may occur more than once in $t$, saving us not only space but also time.

This property holds even for every $(\underline{\Id}+\LC)$-morphism from the $(\Lambda, [\mathsf{var}, \mathsf{app}, \mathsf{abs}])$ if the target is an $\LC$-algebra with substitution.
Accordingly we revise the notion of morphisms for algebras with substitution.
Note that for \eqref{eq:substitution-lemma} to commute, it suffice to consider the right rectangle of the diagram on the right. 
Therefore the condition boils down to the following definition.
\begin{definition}
An \emph{$H$-homomorphism} $f$ between algebras with substitution from $(T, \eta, \alpha, \mu)$ to $(T', \eta', \alpha', \mu')$ is a natural transformation $f\colon T \to T'$ such that $f$ is an $H$-algebra homomorphism from $(T, \alpha)$ to $(T', \alpha')$ and $f$ is a monad morphism from $(T, \eta, \mu)$ to $(T', \eta', \mu')$, i.e.\ satisfying
\[
  \vcenter{
    \xymatrix{
      \Id \ar[r]^{\eta} \ar[rd]_{\eta'} & T \ar[d]^{f} \\
        & T'
    }
  }
  \qquad
  \vcenter{
    \xymatrix{
      HT  \ar[d]_{Hf} \ar[r]^{\alpha} & T \ar[d]^{f} \\
      HT' \ar[r]_{\alpha'} & T'
    }
  }
  \qquad
  \vcenter{
    \xymatrix{
      T \fcomp T \ar[d]_{\mu} \ar[r]^{f \fcomp T} & T' \fcomp T \ar[r]^{T' \fcomp f} & T' \fcomp T' \ar[d]^{\mu'} \\
      T \ar[rr]_{f} & & T'
    }
  }
\]
Let $\AlgS{H}$ denote the category formed by $H$-algebras with substitution and their homomorphisms.
\end{definition}
That is, an $H$-homomorphism between algebras with substitution commutes not only with $H$-algebra structure but also with the monad structure.
In \Cref{sec:binding-signature} we will show that the functor with strength associated with a binding signature, including $\LC$, has an initial algebra with substitution and $(\LC, \mathsf{var}, [\mathsf{app}, \mathsf{abs}], \subst{\blank})$ is indeed the initial algebra.
\Cref{lem:substitution-lemma-fv} follows from initiality immediately once substitution is proved compatible with the $\LC$-algebra map.


\subsection{Initial \texorpdfstring{$H$}{H}-algebra with substitution}

\section{From Signatures to Representations and Scope Checking}

\subsection{Binding Signature}\label{sec:binding-signature}
\LT{Define a binding signature as a sum of products for untyped language with weakening}
\LT{Derive a strong functor along $U$ from a binding signature}

\begin{example}
  \LT{An example of binding signature}
  
\end{example}

\begin{theorem}\label{thm:initial-algebra}
  \LT{Show that the strong functor associated with a signature gives rise to an initial algebra with substitution}
\end{theorem}


\subsection{Morphism between Signatures}
For two (mere) endofunctors $F$ and $F'$ on the same category~$\catC$, a natural transformation $\tau$ may be rightfully called a morphism between signature functors, as it gives rise to a functor turning every $F'$-algebra $(A, \alpha)$ to an $F$-algebra $(A, \alpha \comp \tau_A)$.
If we consider endofunctors on \emph{different} categories, say $\catC$ and $\catC'$, connected by a functor $E\colon \catC' \to \catC$ then a suitable notion of morphism from $F\colon \catC \to \catC$ to $F'\colon \catC' \to \catC'$, defined as a natural transformation $\tau$ from $F\fcomp E$ to $E\fcomp F'$, also gives rise to a functor from $\Alg{F'}$ to $\Alg{F}$.

\begin{definition}[Strong $J$-relative functor]
  Let $(J, e^J, m^J)$ be a monoidal functor from $\Endo{\catC'}$ to $\Endo{\catC}$ where $e^J\colon \Id[\catC] \to J\Id[\catC']$ and $m_{F, G}\colon JF \cdot JG \to J(F \cdot G)$.
\end{definition}


\begin{definition}
  \LT{Define morphism between signatures}
%  \[
%    \xymatrix@C+3em{
%      H(E T) \fcomp JZ \ar[r]^{\theta_{ET, (JZ, e \comp e_J)}} \ar[d]_{\tau_T \fcomp JZ} & H(E T \fcomp JZ) \ar[d]^{Ht_{T, Z}} \\
%      E(H'T) \fcomp JZ \ar[d]_{t_{H'T, Z}} & H (E(T \fcomp Z)) \ar[d]^{\tau_{TZ}} \\
%      E (H'T \fcomp Z) \ar[r]_{E \theta'_{T, (Z, e)}} & E (H'(T \fcomp Z)) \\
%    }
%  \]
\end{definition}
%\begin{theorem}
%  Every morphism of\, $U$-strong signature functor along a strong $J$-relative functor from $(\Endo{\catC}, H, \theta)$ to $(\Endo{\catC'}, H', \theta')$ defines a functor from $\HSS{H, \theta}$ to $\HSS{H', \theta'}$.   
%\end{theorem}

\begin{example}[Type erasure]
  
\end{example}

\LT{Show that each signature morphism defines a morphism between strong functors}
\subsection{Representing Substitution Systems}


\LT[Representations for initial HSSs]{1. Named variable representation; 2. Locally nameless representation; 3. Finitely-scoped representation}

\LT{Translation from named variable to locally nameless representations}
\LT{Translation from locally nameless to finitely-scoped representations}

\subsection{Scope Checking by Initiality}

\LT{Scope checking by initiality}

\section{From Bidirectional Typing Signatures to Type Inference}
\LT{Organise this section clearly}
$H\colon \Endo{\set^{\bool \times \catS}} \to \Endo{\set^{\bool \times \catS}}$ 
where $\bool$ is the free category over the graph $\bfalse, \btrue$ with edges $\bfalse \to \btrue$ and $\btrue \to \bfalse$.
There is a natural \emph{embedding} 
$J\colon \set^{\catS} \to \set^{\bool \times \catS}$ defined by
$(J \Gamma)(\btrue, s) = \Gamma(s)$ and $(J \Gamma)(\bfalse, s) = \Empty$.

\subsection{Signature for Bidirectional Typing}
Mode-Correctness and Annotatability

\subsection{Signature Functor for Bidirectional Typing}

\begin{example}[Direction erasure]
  
\end{example}

\subsection{Type Inference by Initiality}
\LT{Define bidirectional type inference by initiality}

\section{More Examples}


\section{Discussion and Future Work}

\paragraph{Relative monad}
For the sake of clarity, we only consider ordinary monads as the carrier of a heterogeneous substitution system, but however it is nature to use a category of contexts with a different chosen context extension than the one stated in this paper. 
The view motivates the use of relative monad proposed by \citet{Altenkirch2015}.

\paragraph{Comparing frameworks for scoped- and typed-safe syntaxes}

\begin{acks}
The work is supported by the \grantsponsor{MOST}{Ministry of Science and Technology of Taiwan}{https://www.most.gov.tw/} under grant \grantnum{MOST}{MOST 109-2222-E-001-002-MY3}.
\end{acks}

\bibliography{./library}

\appendix
%\section{Appendix}

\end{document}
