%! TEX root = BiSig.tex

\section{Definitions for Simple Type Theories and Bidirectional Type Systems}\label{sec:defs}

\subsection{Simple Types}
\begin{definition}
  A \emph{(simple type) signature} $\Sigma$ consists of a set $I$ and an \emph{arity} function $\arity\colon I \to \mathbb{N}$.
  An inhabitant $i : I$ is meant to represent the \emph{$i$-th operation} $\tyOp_i$ and its \emph{number} $ \arity(i)$ of arguments.

  The judgements of \emph{$\Sigma$-types} and \emph{$\Sigma$-contexts} over a variable set $\Theta$ are defined inductively by \Cref{fig:simple-type,fig:simple-context} respectively.
We write $A : \Type_{\Sigma}(\Theta)$ for $\Theta \vdash_{\Sigma} A$ and $\Gamma \colon \Cxt_{\Sigma}(\Theta)$ for $\Theta \vdash_{\Sigma} \Gamma$ to disambiguate $\Sigma$-types and $\Sigma$-contexts in the case of any confusion.
\end{definition}

\begin{figure}
  \begin{minipage}[b]{.55\textwidth}
    \centering
    \small
    \begin{mathpar}
      \boxed{\Theta\vdash_{\Sigma} A} \\
      \inferrule{\Theta \ni X_i}{\Theta \vdash_\Sigma X_i} \and
    \inferrule{\Theta \vdash_{\Sigma} A_1 \\ \cdots \\ \Theta \vdash_{\Sigma} A_{\arity(o)}}{\Theta \vdash_{\Sigma} \tyOp_o(A_1, \ldots, A_{\arity(o)})}
    \end{mathpar}
    \caption{Type formation}
    \label{fig:simple-type}
  \end{minipage}
  \begin{minipage}[b]{.4\textwidth}
    \centering
    \small
    \begin{mathpar}
      \boxed{\Theta \vdash_{\Sigma} \Gamma} \\
      \inferrule{ }{\Theta \vdash_{\Sigma} \cdot }\and
      \inferrule{\Theta \vdash_{\Sigma} A \\ \Theta\vdash_{\Sigma} \Gamma}{\Theta \vdash_{\Sigma} \Gamma, A}
    \end{mathpar}
    \caption{Context formation}
  \label{fig:simple-context}
  \end{minipage}
\end{figure}

\begin{example}\label{ex:implication}
  Simply typed $\lambda$-calculus $\Lambda_{\bto}$ typically includes a binary implication type denoted by $\bto$ and some base types to ensure that the set of all types is non-empty.
  The type signature $\Sigma_{\bto}$ of simply typed $\lambda$-calculus consists of a binary operation $\bto$ and a base type (nullary operation) $N$.
  In the case of simply typed $\lambda$-calculus $\Lambda_{\bto, \btimes}$ with binary products, we can extend $\Sigma_{\bto}$ by adding a binary operation $\btimes$ to represent the binary product type, denoted as $\Sigma_{\bto, \btimes}$.
\end{example}

\subsection{Binding Signatures} \label{subsec:binding-sig}
\begin{definition}\label{def:binding-signature}
  For a type signature $\Sigma$, a \emph{binding signature} $\Omega$ consists of a set $O$ and a function
  \[
    \mathit{ar}\colon O \to \sum_{\Xi : \N} \left(\Cxt_\Sigma(\Xi) \times \Type_\Sigma(\Xi)\right)^* \times \Type_\Sigma(\Xi).
  \]
  Each inhabitant $o: O$ is meant to represent a term construct $\tmOp_o$ in a simple type theory with a triple $\left(\Xi, \left[\left(\Delta_1; A_1\right), \ldots, \left(\Delta_{n}; A_{n}\right) \right], A\right)$
  instead of a number as its arity $\arity_o$ where
  \begin{enumerate}
    \item $\Xi$ is the number of type variables, 
    \item $A : \Type_\Sigma(\Xi)$ is the target type of $\tmOp_o$, and
    \item $\left[\left(\Delta_1; A_{1}\right), \ldots, \left(\Delta_{n}; A_{n}\right) \right]$ is a list of pairs where
    \item the $i$-th pair $(\Delta_i, A_i) :\Cxt_{\Sigma}(\Xi) \times \Term_{\Sigma}(\Xi)$ are types of the binding variables and the type of the $i$-th argument of $\tmOp_{o}$.
  \end{enumerate}
  For brevity, we write $o \colon \Xi \rhd [\Delta_1]A_{1}, \ldots, \left[\Delta_{n}\right] A_{n} \to A$ to indicate an operation with its arity. 
\end{definition}
\begin{remark}[Terminology on binding signature]
  \cite{Aczel1978,Fiore2010}
\end{remark}


\begin{example} \label{ex:STLC-sig}
  Given the type signature $\Sigma_{\bto}$ for the implication type, the term signature $\Lambda_{\bto}$ for simply typed $\lambda$-calculus can be described by operations
  \begin{align*}
    \mathsf{app}\colon A, B \rhd (A \bto B), A \to B && \mathsf{abs}\colon A , B \rhd [A]B \to (A \bto B)
  \end{align*}
    or, verbosely, the signature $\Lambda_{\bto}$ consists of the type $O_\Lambda = \{\app, \abs\}$ with arities
  \begin{align*}
    \arity(\app) = (\{A, B\}, [(\cdot; A \bto B), (\cdot; A)], B)
    && 
    \arity(\abs) = (\{A, B\}, [(\cdot, A; B)], A \bto B)
  \end{align*}
  For the type signature $\Sigma_{\bto, \btimes}$, the term signature $\Omega_{\bto, \btimes}$ for simply typed $\lambda$-calculus with finite products has three additional operations
to $\Omega_{\bto}$:
  \begin{align*}
    \mathsf{pair}\colon A, B \rhd A, B \to A \btimes B
    && \fst \colon A, B \rhd A \btimes B \to A
    && \snd \colon A, B \rhd A \btimes B \to B
  \end{align*}
\end{example}

First, it is noteworthy that the set of term constructs in a type theory need not be finite.
For instance, a type theory may adopt a spine application which takes indefinitely many arguments---for each number $n$ of arguments an $(n+1)$-ary application construct can be introduced, so even if each operation has a definite number of arguments by definition a spine application is still expressible.

More importantly, the inclusion of the set of variables used in an operation is a salient feature of our binding signatures.
Instead of treating application as a family of constructs $\app_{A, B}$ indexed by all types $A$ and $B$, as done by \citet{Fiore2022}, we are able to identify them as a single construct $\app$.
This is not only for brevity but also necessary to compare the type equality during type synthesis and checking.

%\subsection{Intrinsically Typed Terms}
%
%Intrinsically typed terms for a type signature $\Sigma$ and a term signature $\Omega$ are nothing more than derivations of the intrinsic typing judgement $\Gamma \vdash_{\Sigma, \Omega} A$ constructed with only the rule $(\var)$ and the rule scheme $(\tmOp)$ displayed in \Cref{fig:intrinsic-typing}.
%
%The substitution $\rho\colon \Sub{\Xi}{\emptyset}$ is used to instantiate variables in the local context $\Xi$ with concrete types.
%Accordingly, $\rho$ has to be applied to types that appear in the arity to construct a term by $\tmOp$ to ensure all types are well-formed without any use of type variables.
%
%\begin{figure}
%  \centering
%  \small
%  \begin{mathpar}
%    \boxed{\Gamma \vdash_{\Sigma, \Omega} A} \\
%    \inferrule{A \in \Gamma}{\Gamma \vdash_{\Sigma, \Omega} A}\;(\var)
%    \and
%    \inferrule{\rho\colon \Sub{\Xi}{\emptyset}  \\ \Gamma, \simsub{\Delta_{1}}{\rho} \vdash_{\Sigma, \Omega} \simsub{A_{1}}{\rho} \quad\cdots\quad \Gamma, \simsub{\Delta_{n}}{\rho} \vdash_{\Sigma, \Omega} \simsub{A_{n}}{\rho}}
%    {\Gamma \vdash_{\Sigma, \Omega} \simsub{A}{\rho}}\;(\tmOp)
%    \and \text{for $o\colon \Xi \rhd [\Delta_1]A_1, \ldots, [\Delta_{n}]A_{n} \to A$ in $\Omega$}
%  \end{mathpar}
%  \caption{Intrinsic typing rules for a simple type theory $(\Sigma, \Omega)$}
%  \label{fig:intrinsic-typing}
%\end{figure}

\subsection{Simple Type Theory for a Signature}

\begin{figure}
  \centering
  \small
  \begin{mathpar}
    \boxed{\vdash_{\Sigma, \Omega} \isTerm{t}}
    \\
    \inferrule{x : \Identifier}{\vdash_{\Sigma, \Omega} \isTerm{x}}\;(\text{var})
    \and
    \inferrule{\cdot \vdash_{\Sigma} A \\ \vdash_{\Sigma, \Omega}\isTerm{t}}{\vdash_{\Sigma, \Omega} \isTerm{t \annote A}}\;(\text{anno})
    \\
    \inferrule{\vdash_{\Sigma, \Omega} \isTerm{t_1} \quad \cdots \quad \vdash_{\Sigma, \Omega} \isTerm{t_n}}
    {\vdash_{\Sigma, \Omega} \isTerm{\tmOp_o(t_1, \ldots, t_n)}}\;(\text{op}) 
    \and \text{for $o \colon \Xi \rhd [\Delta_1]A_{1}, \ldots, [\Delta_{n}] A_{n} \to A$ in $\Omega$}
  \end{mathpar}
  \caption{Raw terms for $(\Sigma, \Omega)$ with annotation}
\end{figure}

\begin{figure}
  \centering
  \small
  \begin{mathpar}
    \boxed{\Gamma \vdash_{\Sigma, \Omega} \isTerm{t} : A} \quad \text{where $\vdash_{\Sigma, \Omega} t$} \\
    \inferrule{(x : A) \in \Gamma}{\Gamma \vdash_{\Sigma, \Omega} \isTerm{x} : A}\;(\var)
    \and
    \inferrule{\Gamma \vdash \isTerm{t} : A}{\Gamma \vdash (\isTerm{t \annote A}) : A}\;(\text{anno})
    \and
    \inferrule{\rho : \Sub{\Xi}{\emptyset} \\ \Gamma, \isTerm{\vec{x}_1} : \simsub{\Delta_{1}}{\rho} \vdash_{\Sigma, \Omega} \isTerm{t_1} : \simsub{A_{1}}{\rho} \quad\cdots\quad \Gamma, \isTerm{\vec{x}_n} : \simsub{\Delta_{n}}{\rho} \vdash_{\Sigma, \Omega} \isTerm{t_n} : \simsub{A_{n}}{\rho}}
    {\Gamma \vdash_{\Sigma, \Omega} \isTerm{\tmOp_o(\vec{x}_1.\,t_1; \ldots; \vec{x}_n.\,t_n)} : \simsub{A}{\rho}}\;(\tmOp)
    \and \text{for $o\colon \Xi \rhd [\Delta_1]A_1, \ldots, [\Delta_{n}]A_{n} \to A$ in $\Omega$}
  \end{mathpar}
  \caption{Typing rules for a simple type theory $(\Sigma, \Omega)$ with annotation}
  \label{fig:extrinsic-typing}
\end{figure}

\subsection{Bidirectional Binding Signatures and their Bidirectional Type Systems}

\begin{definition}
  For a type signature $\Sigma$, a \emph{bidirectional binding signature} $\Omega$ is a set $O$ with a function
  \[
    \mathit{ar}\colon O \to \sum_{\Xi : \N} \left(\Cxt_{\Sigma}(\Xi) \times \Type_{\Sigma}(\Xi) \times \isDir{\Mode}\right)^* \times \Type_{\Sigma}(\Xi) \times \isDir{\Mode}.
  \]
  where $\Mode$ consists of two inhabitants $\chk$ for checking and $\syn$ for synthesis.
  Bidirectional binding signatures are just binding signatures (\Cref{def:binding-signature}) augmented with a mode for each argument and its target of a construct $\tmOp_o$ in a bidirectional system, i.e.
  an arity is a $4$-tuple
  \[
    \left(\Xi, \left[\left(\Delta_1; A_1; d_1\right), \ldots, \left(\Delta_{n}; A_{n}; d_n\right) \right], A, d\right)
  \]
  where $d$ and $d_i$'s indicate the modes of a construct and its arguments respectively.

  For brevity, we write $o \colon \Xi \rhd [\Delta_1]A_{1}^{d_1}, \ldots, [\Delta_{n}] A^{d_n}_{n} \to A^{d}$ to indicate an operation with its arity. 
\end{definition}

\begin{example}
  The term signature $\Lambda_{\bto}^{\leftrightarrows}$ for bidirectional simply typed $\lambda$-calculus introduced in \Cref{subsec:binding-sig} can be specified by operations 
  \begin{align*}
    \mathsf{app}\colon A, B \rhd (A \bto B)^{\Rightarrow}, A^{\Leftarrow} \to B^{\Rightarrow} &&
    \mathsf{abs}\colon A , B \rhd [A]B^{\Leftarrow} \to (A \bto B)^{\Leftarrow}
  \end{align*}
  extending $\Lambda_{\bto}$ (\Cref{ex:STLC-sig}) with the mode information.
\end{example}

\LT{Some remark about signature erasure and annotation; introduce the notation $\erase{\Omega}$}

\begin{figure}
  \centering
  \small
  \begin{mathpar}
    \boxed{\vdash_{\Sigma, \Omega} \isTerm{t}^\isDir{d}}
    \quad\text{where $\vdash_{\Sigma, \erase{\Omega}} \isTerm{t}$}
    \\
    \inferrule{x : \Identifier}{\vdash_{\Sigma, \Omega} \isTerm{x}^\isDir{\syn}}\;(\text{var})
    \and
    \inferrule{\cdot \vdash_{\Sigma} A \\ \vdash_{\Sigma, \Omega}\isTerm{t}^\isDir{\chk}}{\vdash_{\Sigma, \Omega} (\isTerm{t \annote A})^\isDir{\syn}}\;(\text{anno})
    \and
    \inferrule{\vdash_{\Sigma, \Omega} \isTerm{t}^\isDir{\syn}}{\vdash_{\Sigma, \Omega} {\isTerm{t\subsum}}^\isDir{\chk}}\;(\text{sub})
  \end{mathpar}
  \begin{mathpar}
    \inferrule{\vdash_{\Sigma, \Omega} \isTerm{t_1}^\isDir{d_1} \quad \cdots \quad \vdash_{\Sigma, \Omega} \isTerm{t_n}^\isDir{d_n}}
    {\vdash_{\Sigma, \Omega} \isTerm{\tmOp_o(\vec{x}_1.\, t_1; \ldots;\vec{x}_n.\, t_n)}^\isDir{d}}\;(\text{op})
    \and \text{for $o \colon \Xi \rhd [\Delta_1]A_{1}^{d_1}, \ldots, [\Delta_{n}] A^{d_n}_{n} \to A^{d}$ in $\Omega$}
  \end{mathpar}
  \caption{Raw terms in some mode $d$ for a bidirectional type system $(\Sigma, \Omega)$}
\end{figure}

\begin{figure}
  \centering
  \small
  \begin{mathpar}
    \boxed{\Gamma \vdash_{\Sigma, \Omega} \isTerm{t} : A^\isDir{d}}
    \quad \text{where $\vdash_{\Sigma, \erase{\Omega}} \isTerm{t}$ and $\vdash_{\Sigma, \Omega} \isTerm{t}^\isDir{d}$} 
    \\
    \inferrule{(x : A) \in \Gamma}{\Gamma \vdash_{\Sigma, \Omega} \isTerm{x} : A^\isDir{\syn}}\;(\var)
    \and
    \inferrule{\Gamma \vdash_{\Sigma, \Omega} \isTerm{t} : A^\isDir{\chk}}{\Gamma \vdash_{\Sigma, \Omega} (\isTerm{t \annote B}):  A^\isDir{\syn}}\;(\text{anno})
    \and
    \inferrule{\Gamma \vdash_{\Sigma, \Omega} \isTerm{t} : B^{\isDir{\syn}} \\ A = B}{\Gamma \vdash_{\Sigma, \Omega} \isTerm{t\subsum} : A^\isDir{\chk}}\;(\text{sub})
    \\
    \inferrule{\rho\colon \Sub{\Xi}{\emptyset} \\ \Gamma, \simsub{\isTerm{\vec{x}_{1}} : \Delta_{1}}{\rho} \vdash_{\Sigma, \Omega} \isTerm{t_{1}} : \simsub{A_{1}}{\rho}^{\isDir{d_1}} \\
      \cdots \\
    \Gamma, \simsub{\isTerm{\vec{x}_{n}} : \Delta_{n}}{\rho} \vdash_{\Sigma, \Omega} \isTerm{t_n} : \simsub{A_{n}}{\rho}^{\isDir{d_n}}}
  {\Gamma \vdash_{\Sigma, \Omega} \isTerm{\tmOp_o(\vec{x}_1 .\, t_{1}; \ldots; \vec{x}_{n}.\, t_{n})} : \simsub{A}{\rho}^{\isDir{d}}} \; (\tmOp)
    \and \text{for $o \colon \Xi \rhd [\Delta_1]A_{1}^{d_1}, \ldots, [\Delta_{n}] A^{d_n}_{n} \to A^{d}$ in $\Omega$}
    \\
    \text{Abbreviations: $\boxed{\Gamma \vdash_{\Sigma, \Omega} \isTerm{t} \Rightarrow A} \defeq \boxed{\Gamma \vdash_{\Sigma, \Omega} \isTerm{t} : A^\isDir{\syn}}$ and $\boxed{\Gamma \vdash_{\Sigma, \Omega} \isTerm{t} \Leftarrow A} \defeq \boxed{\Gamma \vdash_{\Sigma, \Omega} \isTerm{t} : A^\isDir{\chk}}$}
  \end{mathpar}
  \caption{Typing rules for a bidirectional system $(\Sigma, \Omega)$}
\end{figure}

\begin{example}
  
\end{example}



