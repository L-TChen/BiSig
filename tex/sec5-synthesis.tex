%!TEX root = BiSig.tex

\section{Bidirectional Type Synthesis and Checking} \label{sec:type-synthesis}

\subsection{Mode Correctness}
\begin{definition}[Mode-Correctness]
\end{definition}


\begin{theorem}[Uniqueness of the Synthesised Types]\label{thm:unique-syn}
  Let $(\Sigma, \Omega)$ be a mode-correct bidirectional type system.
  Then, for every raw term $t$ in synthesising mode and two derivations of 
  \[
    \Gamma |-_{\Sigma, \Omega} t \syn A
    \quad\text{and}\quad
    \Gamma |-_{\Sigma, \Omega} t \syn B
  \]
  for some types $A$ and $B$ respectively, the synthesised types must be equal, i.e.\ $A = B$.
\end{theorem}
 

\subsection{Trichotomy of Raw Terms by Type Synthesis}

\begin{theorem}[Decidability of Bidirectional Type Synthesis] \label{thm:bidirectional-type-synthesis}
  Let $(\Sigma, \Omega)$ be a mode-correct bidirectional type system.
  Then, every context $\Gamma$ and raw term $\isTerm{t}$ in synthesising mode decide whether
  \[
    \Gamma |-_{\Sigma, \Omega} \isTerm{t} \syn A
  \]
  has a derivation for some type $A$.
\end{theorem}

\begin{corollary}[Trichotomy of Raw Terms]
  Let $(\Sigma, \Omega)$ be a mode-correct bidirectional type system.
  Then, for every context $\Gamma$ and raw term $t$, exactly one of the following statements holds:
  \begin{enumerate}
    \item $t$ is synthesising and the judgement $\Gamma |-_{\Sigma, \Omega} t : A$ has a derivation for some type $A$.
    \item $t$ is synthesising but the judgement $\Gamma |-_{\Sigma, \Omega} t : A$ has no derivation for any type $A$.
    \item $t$ is not synthesising.
  \end{enumerate}
\end{corollary}
\begin{proof}
  Combine  \Cref{thm:term-soundness,thm:term-completeness,thm:bidirectionalisation} with \Cref{thm:bidirectional-type-synthesis}.
  
\end{proof}

\subsection{Decidability of Bidirectional Type Synthesis and Checking}


\begin{theorem}[Decidability of Bidirectional Type Synthesis and Checking] \label{thm:bidirectional-type-synthesis-checking}
  Let $(\Sigma, \Omega)$ be a mode-correct bidirectional type system.
  For every context $\Gamma$ and raw term $\isTerm{t}$ in mode $d$, 
  \begin{enumerate}
    \item if $\isTerm{t}$ is synthesising, then it is decidable whether there is a type~$A$ and a derivation of
      \[
        \Gamma |-_{\Sigma, \Omega} \isTerm{t} \syn A.
      \]
    \item if $\isTerm{t}$ is checking, then every type $A$ decides whether there is a derivation of
      \[
        \Gamma |-_{\Sigma, \Omega} \isTerm{t} \chk A.
      \]
  \end{enumerate}
\end{theorem}
\begin{lemma}\label{lem:args-induction}
  Assume \Cref{thm:bidirectional-type-synthesis}.
  Then, for every set $\Xi$ of type variables, list 
  \[
    \mathit{as} = \left([\Delta_i] A_{i}^{\dir{d_i}}\right)_{i = 1}^{n}
  \]
  list of raw terms $t_i$'s in mode $d_i$, context $\Gamma$, and \emph{partial} substitution $\rho$ from $\Xi$ to $\emptyset$
  \begin{enumerate}
    \item either there is a minimal extension $\ext{\rho}$ of $\rho$ defined on $\synvar(\mathit{as})$ such that all of following judgements are derivable
      \[
        \Gamma, \simsub{\Delta_i}{\ext{\rho}} |-_{\Sigma, \Omega} \isTerm{t_i} \colon \simsub{A_i}{\ext{\rho}}^{\dir{d_i}}
      \]

    \item or there is no extension $\sigma$ of $\rho$ such that all $\Gamma, \simsub{\Delta_i}{\sigma} |-_{\Sigma, \Omega} \isTerm{t_i} \colon \simsub{A_i}{\sigma}^{\dir{d_i}}$ has a typing derivation. 
  \end{enumerate}
\end{lemma}

\begin{proof}[Proof of {\Cref{thm:bidirectional-type-synthesis}}]
  We prove this statement by induction on the derivation of $|-_{\Sigma, \Omega} \isTerm{t}^{d}$ (instead of $t$ alone).
  The first two cases \SynRule{Var} and \SynRule{Anno} are straightforward and have nothing to do with mode-correctness directly.
  The third case \ChkRule{Sub} invokes the uniqueness of synthesised types to refute the case that $\Gamma |- t \syn B$ but $A \neq B$ for a given type $A$ to check.
  The last case \Rule{Op} is the interesting part of this theorem.
  \begin{description}
    \item[\SynRule{Var}:] If $t$ is a variable $x$ in the context $\Gamma$, then there exists a type $A$ such that $\Gamma |- x \syn A$.
      Otherwise, if $x$ is not in $\Gamma$ but $\Gamma |- x \syn A$ is derivable, then by inversion $x$ must be in $\Gamma$, a contradiction.
    \item[\SynRule{Anno}:] For a raw term of the form $(t : A)$ in synthesising mode, it is decidable that $\Gamma |- t \chk A$ is derivable or not by induction hypothesis.
      \begin{enumerate}
        \item If $\Gamma |- t \chk A$ is derivable, then $\Gamma |- (t : A) \syn A$ is derivable.
        \item If $\Gamma |- t \chk A$ is not derivable but $\Gamma |- (t : A) \syn$ is derivable, then by inversion $\Gamma |- t \chk A$ is derivable, thus a contradiction.
      \end{enumerate}
      
    \item[\ChkRule{Sub}:] If $t$ is in checking mode because of the subsumption rule, then by induction hypothesis it is decidable whether $\Gamma |- t \syn B$ for some $B$:
      \begin{enumerate}
        \item If $\Gamma |- t \syn B$ is derivable for some $B$, then we have to consider any type $A$ and it is decidable if $A$ is equal to $B$:
          \begin{enumerate}
            \item if $A = B$ then we have arrived a derivation of $\Gamma |- t \chk A$.
            \item if $A \neq B$ but $\Gamma |- t \chk A$ is derivable, then by inversion $\Gamma |- t \syn A$.
              However, by \Cref{thm:unique-syn}, synthesised types $A$ and $B$ must be equal, so it is a contradiction.
          \end{enumerate}
        \item if $\Gamma |- t \syn C$ is not derivable for any type $C$ but $\Gamma |- t \chk A$ is derivable, then by inversion $\Gamma |- t \syn B$ for some $B = A$, thus a contradiction.
      \end{enumerate}
      
%    \item For every mode-correct operation $o \colon \Xi \rhd [\Delta_1]A_{1}^{d_1}, \ldots, [\Delta_{n}] A^{d_n}_{n} \to A^{d}$, a context $\Gamma$, and a raw term
%      \[
%        \isTerm{\tmOp_{o}(\vec{x}_1.t_1,\ldots, \vec{x}_n.t_n)}, 
%      \]
%      with a mode $d$, it is decidable that there exists a substitution $\rho$ from $\Xi$ to $\emptyset$ and a typing derivation of
%      \[
%        \Gamma |-_{\Sigma, \Omega} \isTerm{\tmOp_{o}(\vec{x}_1.t_1,\ldots, \vec{x}_n.t_n)} : \simsub{A}{\rho}^{d}.
%      \]
    \item[\Rule{Op}:]
      Suppose that $t$ is of them $\tmOp_o(\vec{x}_1.t_1; \ldots; \vec{x}_n.t_n)$ for some mode-correct operation $o$ in $\Omega$.
      No matter $t$ is checking or synthesising, we need to build derivations for its arguments incrementally and maintain a set of unifiers, i.e.\ a partial substitution $\rho\colon \PSub{\Xi}{\emptyset}$ is incrementally defined which is initially defined nowhere if $t$ is synthesising or on variables of the target $A$ if $t$ is checking. 

  \end{description}
\end{proof}
