%!TEX root = BiSig.tex

\documentclass[BiSig.tex]{subfiles}


%% ODER: format ==         = "\mathrel{==}"
%% ODER: format /=         = "\neq "
%
%
\makeatletter
\@ifundefined{lhs2tex.lhs2tex.sty.read}%
  {\@namedef{lhs2tex.lhs2tex.sty.read}{}%
   \newcommand\SkipToFmtEnd{}%
   \newcommand\EndFmtInput{}%
   \long\def\SkipToFmtEnd#1\EndFmtInput{}%
  }\SkipToFmtEnd

\newcommand\ReadOnlyOnce[1]{\@ifundefined{#1}{\@namedef{#1}{}}\SkipToFmtEnd}
\usepackage{amstext}
\usepackage{amssymb}
\usepackage{stmaryrd}
\DeclareFontFamily{OT1}{cmtex}{}
\DeclareFontShape{OT1}{cmtex}{m}{n}
  {<5><6><7><8>cmtex8
   <9>cmtex9
   <10><10.95><12><14.4><17.28><20.74><24.88>cmtex10}{}
\DeclareFontShape{OT1}{cmtex}{m}{it}
  {<-> ssub * cmtt/m/it}{}
\newcommand{\texfamily}{\fontfamily{cmtex}\selectfont}
\DeclareFontShape{OT1}{cmtt}{bx}{n}
  {<5><6><7><8>cmtt8
   <9>cmbtt9
   <10><10.95><12><14.4><17.28><20.74><24.88>cmbtt10}{}
\DeclareFontShape{OT1}{cmtex}{bx}{n}
  {<-> ssub * cmtt/bx/n}{}
\newcommand{\tex}[1]{\text{\texfamily#1}}	% NEU

\newcommand{\Sp}{\hskip.33334em\relax}


\newcommand{\Conid}[1]{\mathit{#1}}
\newcommand{\Varid}[1]{\mathit{#1}}
\newcommand{\anonymous}{\kern0.06em \vbox{\hrule\@width.5em}}
\newcommand{\plus}{\mathbin{+\!\!\!+}}
\newcommand{\bind}{\mathbin{>\!\!\!>\mkern-6.7mu=}}
\newcommand{\rbind}{\mathbin{=\mkern-6.7mu<\!\!\!<}}% suggested by Neil Mitchell
\newcommand{\sequ}{\mathbin{>\!\!\!>}}
\renewcommand{\leq}{\leqslant}
\renewcommand{\geq}{\geqslant}
\usepackage{polytable}

%mathindent has to be defined
\@ifundefined{mathindent}%
  {\newdimen\mathindent\mathindent\leftmargini}%
  {}%

\def\resethooks{%
  \global\let\SaveRestoreHook\empty
  \global\let\ColumnHook\empty}
\newcommand*{\savecolumns}[1][default]%
  {\g@addto@macro\SaveRestoreHook{\savecolumns[#1]}}
\newcommand*{\restorecolumns}[1][default]%
  {\g@addto@macro\SaveRestoreHook{\restorecolumns[#1]}}
\newcommand*{\aligncolumn}[2]%
  {\g@addto@macro\ColumnHook{\column{#1}{#2}}}

\resethooks

\newcommand{\onelinecommentchars}{\quad-{}- }
\newcommand{\commentbeginchars}{\enskip\{-}
\newcommand{\commentendchars}{-\}\enskip}

\newcommand{\visiblecomments}{%
  \let\onelinecomment=\onelinecommentchars
  \let\commentbegin=\commentbeginchars
  \let\commentend=\commentendchars}

\newcommand{\invisiblecomments}{%
  \let\onelinecomment=\empty
  \let\commentbegin=\empty
  \let\commentend=\empty}

\visiblecomments

\newlength{\blanklineskip}
\setlength{\blanklineskip}{0.66084ex}

\newcommand{\hsindent}[1]{\quad}% default is fixed indentation
\let\hspre\empty
\let\hspost\empty
\newcommand{\NB}{\textbf{NB}}
\newcommand{\Todo}[1]{$\langle$\textbf{To do:}~#1$\rangle$}

\EndFmtInput
\makeatother
%
%
%
%
%
%
% This package provides two environments suitable to take the place
% of hscode, called "plainhscode" and "arrayhscode". 
%
% The plain environment surrounds each code block by vertical space,
% and it uses \abovedisplayskip and \belowdisplayskip to get spacing
% similar to formulas. Note that if these dimensions are changed,
% the spacing around displayed math formulas changes as well.
% All code is indented using \leftskip.
%
% Changed 19.08.2004 to reflect changes in colorcode. Should work with
% CodeGroup.sty.
%
\ReadOnlyOnce{polycode.fmt}%
\makeatletter

\newcommand{\hsnewpar}[1]%
  {{\parskip=0pt\parindent=0pt\par\vskip #1\noindent}}

% can be used, for instance, to redefine the code size, by setting the
% command to \small or something alike
\newcommand{\hscodestyle}{}

% The command \sethscode can be used to switch the code formatting
% behaviour by mapping the hscode environment in the subst directive
% to a new LaTeX environment.

\newcommand{\sethscode}[1]%
  {\expandafter\let\expandafter\hscode\csname #1\endcsname
   \expandafter\let\expandafter\endhscode\csname end#1\endcsname}

% "compatibility" mode restores the non-polycode.fmt layout.

\newenvironment{compathscode}%
  {\par\noindent
   \advance\leftskip\mathindent
   \hscodestyle
   \let\\=\@normalcr
   \let\hspre\(\let\hspost\)%
   \pboxed}%
  {\endpboxed\)%
   \par\noindent
   \ignorespacesafterend}

\newcommand{\compaths}{\sethscode{compathscode}}

% "plain" mode is the proposed default.
% It should now work with \centering.
% This required some changes. The old version
% is still available for reference as oldplainhscode.

\newenvironment{plainhscode}%
  {\hsnewpar\abovedisplayskip
   \advance\leftskip\mathindent
   \hscodestyle
   \let\hspre\(\let\hspost\)%
   \pboxed}%
  {\endpboxed%
   \hsnewpar\belowdisplayskip
   \ignorespacesafterend}

\newenvironment{oldplainhscode}%
  {\hsnewpar\abovedisplayskip
   \advance\leftskip\mathindent
   \hscodestyle
   \let\\=\@normalcr
   \(\pboxed}%
  {\endpboxed\)%
   \hsnewpar\belowdisplayskip
   \ignorespacesafterend}

% Here, we make plainhscode the default environment.

\newcommand{\plainhs}{\sethscode{plainhscode}}
\newcommand{\oldplainhs}{\sethscode{oldplainhscode}}
\plainhs

% The arrayhscode is like plain, but makes use of polytable's
% parray environment which disallows page breaks in code blocks.

\newenvironment{arrayhscode}%
  {\hsnewpar\abovedisplayskip
   \advance\leftskip\mathindent
   \hscodestyle
   \let\\=\@normalcr
   \(\parray}%
  {\endparray\)%
   \hsnewpar\belowdisplayskip
   \ignorespacesafterend}

\newcommand{\arrayhs}{\sethscode{arrayhscode}}

% The mathhscode environment also makes use of polytable's parray 
% environment. It is supposed to be used only inside math mode 
% (I used it to typeset the type rules in my thesis).

\newenvironment{mathhscode}%
  {\parray}{\endparray}

\newcommand{\mathhs}{\sethscode{mathhscode}}

% texths is similar to mathhs, but works in text mode.

\newenvironment{texthscode}%
  {\(\parray}{\endparray\)}

\newcommand{\texths}{\sethscode{texthscode}}

% The framed environment places code in a framed box.

\def\codeframewidth{\arrayrulewidth}
\RequirePackage{calc}

\newenvironment{framedhscode}%
  {\parskip=\abovedisplayskip\par\noindent
   \hscodestyle
   \arrayrulewidth=\codeframewidth
   \tabular{@{}|p{\linewidth-2\arraycolsep-2\arrayrulewidth-2pt}|@{}}%
   \hline\framedhslinecorrect\\{-1.5ex}%
   \let\endoflinesave=\\
   \let\\=\@normalcr
   \(\pboxed}%
  {\endpboxed\)%
   \framedhslinecorrect\endoflinesave{.5ex}\hline
   \endtabular
   \parskip=\belowdisplayskip\par\noindent
   \ignorespacesafterend}

\newcommand{\framedhslinecorrect}[2]%
  {#1[#2]}

\newcommand{\framedhs}{\sethscode{framedhscode}}

% The inlinehscode environment is an experimental environment
% that can be used to typeset displayed code inline.

\newenvironment{inlinehscode}%
  {\(\def\column##1##2{}%
   \let\>\undefined\let\<\undefined\let\\\undefined
   \newcommand\>[1][]{}\newcommand\<[1][]{}\newcommand\\[1][]{}%
   \def\fromto##1##2##3{##3}%
   \def\nextline{}}{\) }%

\newcommand{\inlinehs}{\sethscode{inlinehscode}}

% The joincode environment is a separate environment that
% can be used to surround and thereby connect multiple code
% blocks.

\newenvironment{joincode}%
  {\let\orighscode=\hscode
   \let\origendhscode=\endhscode
   \def\endhscode{\def\hscode{\endgroup\def\@currenvir{hscode}\\}\begingroup}
   %\let\SaveRestoreHook=\empty
   %\let\ColumnHook=\empty
   %\let\resethooks=\empty
   \orighscode\def\hscode{\endgroup\def\@currenvir{hscode}}}%
  {\origendhscode
   \global\let\hscode=\orighscode
   \global\let\endhscode=\origendhscode}%

\makeatother
\EndFmtInput
%
%
\ReadOnlyOnce{agda.fmt}%


\RequirePackage[T1]{fontenc}
\RequirePackage[utf8]{inputenc}
\RequirePackage{amsfonts}

\providecommand\mathbbm{\mathbb}

% TODO: Define more of these ...
\DeclareUnicodeCharacter{737}{\textsuperscript{l}}
\DeclareUnicodeCharacter{8718}{\ensuremath{\blacksquare}}
\DeclareUnicodeCharacter{8759}{::}
\DeclareUnicodeCharacter{9669}{\ensuremath{\triangleleft}}
\DeclareUnicodeCharacter{8799}{\ensuremath{\stackrel{\scriptscriptstyle ?}{=}}}
\DeclareUnicodeCharacter{10214}{\ensuremath{\llbracket}}
\DeclareUnicodeCharacter{10215}{\ensuremath{\rrbracket}}
\DeclareUnicodeCharacter{27E6}{\ensuremath{\llbracket}}
\DeclareUnicodeCharacter{27E7}{\ensuremath{\rrbracket}}
\DeclareUnicodeCharacter{2200}{\ensuremath{\forall}}
\DeclareUnicodeCharacter{2218}{\ensuremath{\circ}}

\DeclareUnicodeCharacter{2294}{\ensuremath{\sqcup}}

\DeclareUnicodeCharacter{1D43}{\ensuremath{^a}}
\DeclareUnicodeCharacter{1D9C}{\ensuremath{^c}}
\DeclareUnicodeCharacter{02B3}{\ensuremath{^r}}
\DeclareUnicodeCharacter{02E2}{\ensuremath{^s}}

\DeclareUnicodeCharacter{2080}{\ensuremath{_0}}
\DeclareUnicodeCharacter{2081}{\ensuremath{_1}}
\DeclareUnicodeCharacter{2082}{\ensuremath{_2}}
\DeclareUnicodeCharacter{2083}{\ensuremath{_3}}
\DeclareUnicodeCharacter{2084}{\ensuremath{_4}}

\DeclareUnicodeCharacter{2115}{\ensuremath{\mathbb{N}}}
\DeclareUnicodeCharacter{2208}{\ensuremath{\in}}
\DeclareUnicodeCharacter{2236}{:}
\DeclareUnicodeCharacter{2261}{\ensuremath{\equiv}}
\DeclareUnicodeCharacter{2237}{\ensuremath{\mathrel{::}}}
\DeclareUnicodeCharacter{2982}{\ensuremath{\bbcolon}}

\DeclareUnicodeCharacter{0393}{\ensuremath{\Gamma}}
\DeclareUnicodeCharacter{0394}{\ensuremath{\Delta}}
\DeclareUnicodeCharacter{0398}{\ensuremath{\Theta}}
\DeclareUnicodeCharacter{03A3}{\ensuremath{\Sigma}}
\DeclareUnicodeCharacter{039B}{\ensuremath{\Lambda}}
\DeclareUnicodeCharacter{039E}{\ensuremath{\Xi}}

\DeclareUnicodeCharacter{03B9}{\ensuremath{\iota}}
\DeclareUnicodeCharacter{03BB}{\ensuremath{\lambda}}
\DeclareUnicodeCharacter{03C0}{\ensuremath{\pi}}
\DeclareUnicodeCharacter{03C3}{\ensuremath{\sigma}}
\DeclareUnicodeCharacter{03C9}{\ensuremath{\omega}}

\DeclareUnicodeCharacter{2032}{\ensuremath{{}^\prime}}
\DeclareUnicodeCharacter{2113}{\ensuremath{\ell}}
\DeclareUnicodeCharacter{2207}{\ensuremath{\nabla}}
\DeclareUnicodeCharacter{220B}{\ensuremath{\ni}}
\DeclareUnicodeCharacter{2264}{\ensuremath{\leq}}
\DeclareUnicodeCharacter{21D0}{\ensuremath{\Leftarrow}}
\DeclareUnicodeCharacter{21D2}{\ensuremath{\Rightarrow}}
\DeclareUnicodeCharacter{22A2}{\ensuremath{\vdash}}
\DeclareUnicodeCharacter{22A4}{\ensuremath{\top}}
\DeclareUnicodeCharacter{22A5}{\ensuremath{\bot}}

\DeclareUnicodeCharacter{1D57}{\ensuremath{^t}}

% TODO: This is in general not a good idea.
\providecommand\textepsilon{$\epsilon$}
\providecommand\textmu{$\mu$}


%Actually, varsyms should not occur in Agda output.

% TODO: Make this configurable. IMHO, italics doesn't work well
% for Agda code.

\renewcommand\Varid[1]{\mathord{\textsf{#1}}}
\let\Conid\Varid
\newcommand\Keyword[1]{\textsf{\textbf{#1}}}

\EndFmtInput




\begin{document}

\section{Formalisation} \label{sec:formalisation}
As we have mentioned in \Cref{sec:intro}, our theory was initially developed with \Agda.
While the translation to the natural language is reasonably straightforward, understanding the formalisation itself could be difficult.
If the reader is comfortable with the informal presentation and assured by the existence of its formalisation, they may feel free to skip this section.

\paragraph{Revisiting language formalisation frameworks}
Unlike prior frameworks~\citep{Allais2021,Fiore2022,Ahrens2022} that have primarily focused on meta-properties centred around substitution for intrinsically-typed terms, our theory of bidirectional type synthesis does not require term substitution but structural induction for extrinsically-typed terms.
The formal definitions of extrinsic typing are more complex than their intrinsic counterparts.
%For a specific language such as \PCF, \citet{Wadler2022} noted that `extrinsically-typed terms require about 1.6 times as much code as intrinsically-typed' for their formalisation of type safety.
%For our generic definitions,
Take our formal definition of typing derivations $\Gamma \vdash_{\Sigma, \Omega} \isTerm{t} : A$ as an example.
Its intrinsic definition is just one family of sets of typed terms indexed by $A$ and $\Gamma$, but its extrinsic counterpart is a generic family of sets indexed by additionally a generic raw term $t$, involving constructions of two different layers.

\paragraph{Category-theoretic analysis of well-typed terms}
The difference between intrinsic typing and extrinsic typing could be partly manifested by \citet{Fiore1999}{'s} theory of abstract syntax and variable binding which forms the foundation of \citet{Fiore2022}'s framework and inspires other referenced frameworks.
Let us take a closer look of their idea.
The set of (untyped) abstract syntax trees for a language can be understood as
\begin{enumerate*}
  \item a family of sets $\Term_{\Gamma}$ of well-scoped terms under a context~$\Gamma$ with
  \item variable renaming for a function $\sigma\colon \Gamma \to \Delta$ between variables acting as a functorial map from $\Term_{\Gamma}$ to $\Term_{\Delta}$, i.e.\ a presheaf $\Term\colon \mathbb{F} \to \mathsf{Set}$, and
  \item an \emph{initial} algebra $[\mathsf{v}, \mathsf{op}]$ on~$\Term$ given by the variable rule as a map $\mathsf{v}$ from the presheaf $V\colon \mathbb{F} \hookrightarrow \mathsf{Set}$ of variables to $\Term$ and other constructs as $\mathsf{op}\colon \mathbb{\Sigma}\Term \to \Term$ where $\mathbb{F}$ is the category of contexts and the functor $\mathbb{\Sigma}\colon \mathsf{Set}^\mathbb{F} \to \mathsf{Set}^\mathbb{F}$ encodes the binding arities of constructs. 
  The initiality amounts to structural recursion on terms, namely \emph{term traversal}.
\end{enumerate*}
Substitution for $\Term$ is modelled as a monoid in the category of presheaves.
To put it succinctly, it is the free $\mathbb{\Sigma}$-monoid over the presheaf~$V$ of variables.

Such an initial algebra can be constructed by the Initial Algebra Theorem~\cite{Trnkova1975}.

\paragraph{Type-theoretic construction of well-typed terms}
Fortunately, in type theory, constructing the initial algebra of well-typed terms boils down to defining an inductive type with a few constructors that align primitive rules (such as $\Rule{Var}$) and a rule schema; term traversal can be defined by pattern matching as usual for the inductive type~\citep{Fiore2022}.

\paragraph{Lack of a theory for extrinsic typing}
While the theory of \citet{Fiore1999} and others provide significant insights, they do not consider extrinsic typing.
We find inspiration in the interpretation of structural induction as algebras for an endofunctor on the category of predicates over a base category, as put forward by \citet{Hermida1998}.
From this perspective, we interpret extrinsic typing as a signature `functor' on the category of predicates consisting of a $\N$-indexed family $X$ of sets and another family $Y$ of sets over $X$; constructing typing derivations as its initial algebra over well-scoped terms.
Our formal construction appears novel and we believe that a theoretic understanding of our construction and its connection to intrinsic typing as a bridge between raw terms and well-typed terms deserve some attention.
However, carrying out a category-theoretic analysis requires expertise in category theory, which goes beyond the scope of this paper.

Therefore, in this section, we will primarily provide an overview of our design and offer intuitive explanations.
We will discuss the construction of simple types in \Cref{subsec:formal-simple-types}, raw terms in~\Cref{subsec:formal-raw-terms}, and bidirectional typing rules in \Cref{subsec:formal-bidirectional-typing}.
Since the formal proofs largely reflect their informal presentation, we will limit our illustration to the 'if' part of \Cref{lem:soundness-completeness} as an example in \Cref{subsec:formal-proofs}.

\subsection{Defining Simple Types}\label{subsec:formal-simple-types}


\begin{figure}
  \codefigure
  \small
  \begin{minipage}[t]{.45\textwidth}
    \begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{13}{@{}>{\hspre}l<{\hspost}@{}}%
\column{16}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\Conid{SigD}\;\mathbin{:}\;\Conid{Set₁}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{Op}\;{}\<[13]%
\>[13]{}\mathbin{:}\;{}\<[16]%
\>[16]{}\Conid{Set}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{decEq}\;{}\<[13]%
\>[13]{}\mathbin{:}\;{}\<[16]%
\>[16]{}\Conid{DecEq}\;\Conid{Op}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{ar}\;{}\<[13]%
\>[13]{}\mathbin{:}\;{}\<[16]%
\>[16]{}\Conid{Op}\;\Varid{→}\;\Conid{ℕ}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
  \end{minipage}
  \begin{minipage}[t]{.45\textwidth}
    \begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{24}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{⟦\char95 ⟧}\;\mathbin{:}\;\Conid{SigD}\;\Varid{→}\;\Conid{Set}\;\Varid{→}\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Conid{D}\;\Varid{⟧}\;\Conid{X}\;\mathrel{=}\;\Conid{Σ[}\;\Varid{i}\;\Varid{∈}\;\Conid{D}\;\Varid{.Op}\;\mskip1.5mu]\;\Conid{X}\;\hat{}\;(\Conid{D}\;\Varid{.ar}\;\Varid{i}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Keyword{data}\;\Conid{Ty}\;(\Conid{Ξ}\;\mathbin{:}\;\Conid{ℕ})\;\mathbin{:}\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\text{\textasciigrave}\anonymous \;{}\<[8]%
\>[8]{}\mathbin{:}\;\Conid{Fin}\;\Conid{Ξ}\;{}\<[24]%
\>[24]{}\Varid{→}\;\Conid{Ty}\;\Conid{Ξ}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{op}\;{}\<[8]%
\>[8]{}\mathbin{:}\;\Varid{⟦}\;\Conid{D}\;\Varid{⟧}\;(\Conid{Ty}\;\Conid{Ξ})\;{}\<[24]%
\>[24]{}\Varid{→}\;\Conid{Ty}\;\Conid{Ξ}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
  \end{minipage}
  \caption{Simple types in \Agda}
  \label{fig:formal-simple-type}
\end{figure}
We start with the formal definition of signatures and simple types (\Cref{fig:formal-simple-type}), which parallels its informal counterpart (\Cref{def:simple-signature}), with the exception of \ensuremath{\Varid{⟦\char95 ⟧}}.
To prevent circular references during the inductive definition of simple types, we initially define \ensuremath{\Varid{⟦}\;\Conid{D}\;\Varid{⟧}} on an arbitrary \ensuremath{\Conid{Set}} instead of\/ \ensuremath{\Conid{Ty}}.
Thus, types specified by a signature can be defined inductively where each inhabitant \ensuremath{\Varid{op}\;(\Varid{i}\;\Varid{,}\;\Varid{ts})} for the $\Rule{Op}$ rule is a pair of an operation symbol and a list of length $n$.

From a categorical view, \ensuremath{\Varid{⟦}\;\Conid{D}\;\Varid{⟧}} is a functor from \ensuremath{\Conid{Set}} to \ensuremath{\Conid{Set}}, mapping $X$ to an $\Conid{Op}$-indexed coproduct $\sum_{i \in \Conid{Op}} X ^ {\Conid{ar}(i)}$ of products of $X$.
The type \ensuremath{\Conid{Ty}} is the free \ensuremath{\Varid{⟦}\;\Conid{D}\;\Varid{⟧}}-algebra over the type \ensuremath{\Conid{Fin}\;\Conid{Ξ}} or the initial algebra for the functor \ensuremath{\Conid{Fin}\;\Conid{Ξ}\;\Varid{+}\;\Varid{⟦}\;\Conid{D}\;\Varid{⟧}}.

\subsection{Defining Raw Terms}\label{subsec:formal-raw-terms}

As shown in \Cref{fig:formal-bibisig}, we define \ensuremath{\Conid{ArgD}}, \ensuremath{\Conid{OpD}}, and \ensuremath{\Conid{SigD}} to represent arguments $[\Delta]A^{\dir{d}}$, bidirectional binding operations $\biop$, and bidirectional binding signatures, respectively, in line with their informal definitions.
By removing \ensuremath{\Varid{mode}} from these definitions, we retrieve the definitions of binding arguments, arities, and signatures.
\begin{figure}
  \codefigure
  \begin{minipage}[t]{.3\textwidth}
  \begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{19}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\Conid{ArgD}\;(\Conid{Ξ}\;\mathbin{:}\;\Conid{ℕ})\;\mathbin{:}\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{cxt}\;{}\<[19]%
\>[19]{}\mathbin{:}\;\Conid{Cxt}\;\Conid{Ξ}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{type}\;{}\<[19]%
\>[19]{}\mathbin{:}\;\Conid{Ty}\;\Conid{Ξ}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\dir{\Varid{mode}}\;{}\<[19]%
\>[19]{}\mathbin{:}\;\Conid{Mode}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Conid{ArgsD}\;\mathrel{=}\;\Conid{List}\;\Varid{∘}\;\Conid{ArgD}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
  \end{minipage}
  \begin{minipage}[t]{.33\textwidth}
  \begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{21}{@{}>{\hspre}l<{\hspost}@{}}%
\column{29}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\Conid{OpD}\;\mathbin{:}\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{constructor}\;\Varid{ι}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\{\mskip1.5mu \Varid{tvars}\mskip1.5mu\}\;{}\<[21]%
\>[21]{}\mathbin{:}\;\Conid{ℕ}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\dir{\Varid{mode}}\;{}\<[21]%
\>[21]{}\mathbin{:}\;\Conid{Mode}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{type}\;{}\<[21]%
\>[21]{}\mathbin{:}\;\Conid{TExp}\;{}\<[29]%
\>[29]{}\Varid{tvars}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{args}\;{}\<[21]%
\>[21]{}\mathbin{:}\;\Conid{ArgsD}\;\Varid{tvars}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
  \end{minipage}
  \begin{minipage}[t]{.3\textwidth}
   \begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{record}\;\Conid{SigD}\;\mathbin{:}\;\Conid{Set₁}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{constructor}\;\Varid{sigd}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Keyword{field}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Conid{Op}\;{}\<[15]%
\>[15]{}\mathbin{:}\;\Conid{Set}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{ar}\;{}\<[15]%
\>[15]{}\mathbin{:}\;\Conid{Op}\;\Varid{→}\;\Conid{OpD}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
  \end{minipage}
  \caption{Bidirectional binding signature in \Agda}
  \label{fig:formal-bibisig}
\end{figure}

To construct well-scoped raw terms indexed by a list $V$ of free variables, we introduce another signature functor mapping \ensuremath{\Conid{Fam}} to \ensuremath{\Conid{Fam}}, where \ensuremath{\Conid{Fam}} is the family of sets defined as \ensuremath{\Conid{ℕ}\;\Varid{→}\;\Conid{Set}}, indexed by a natural number indicating the number of free variables.
This functor for raw term construction resembles the one for defining simple types.
However, we define four distinct functors instead of directly defining one .
These are \ensuremath{\Varid{⟦}\;\Conid{Δ}\;\Varid{⟧ᵃ}} for an extension context \ensuremath{\Conid{Δ}}, \ensuremath{\Varid{⟦}\;\Conid{Ds}\;\Varid{⟧ᵃˢ}} for an argument list \ensuremath{\Conid{Ds}}, \ensuremath{\Varid{⟦}\;\Varid{ι}\;\Conid{Ds}\;\anonymous \;\Varid{⟧ᶜ}} for an operation (\ensuremath{\Varid{ι}\;\Conid{Ds}\;\Conid{A}}), and \ensuremath{\Varid{⟦}\;\Conid{D}\;\Varid{⟧ᶜ}} for a binding signature $D$.
Notably, the functor \ensuremath{\Varid{⟦}\;\Conid{Δ}\;\Varid{⟧ᵃ}} extends the context by mapping the family of sets \ensuremath{\Conid{X}\;\Varid{n}} to \ensuremath{\Conid{X}\;(\Varid{length}\;\Conid{Δ}\;\Varid{+}\;\Varid{n})}.
\begin{figure}
  \codefigure
\begin{minipage}[t]{.33\textwidth}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{17}{@{}>{\hspre}l<{\hspost}@{}}%
\column{19}{@{}>{\hspre}l<{\hspost}@{}}%
\column{22}{@{}>{\hspre}l<{\hspost}@{}}%
\column{27}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{⟦\char95 ⟧ᵃ}\;{}\<[8]%
\>[8]{}\mathbin{:}\;\Conid{TExps}\;\Conid{Ξ}\;{}\<[19]%
\>[19]{}\Varid{→}\;\Conid{Fam}\;\Varid{→}\;\Conid{Fam}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Conid{Δ}\;{}\<[17]%
\>[17]{}\Varid{⟧ᵃ}\;{}\<[22]%
\>[22]{}\Conid{X}\;\Varid{n}\;{}\<[27]%
\>[27]{}\mathrel{=}\;{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Conid{X}\;(\Varid{length}\;\Conid{Δ}\;\Varid{+}\;\Varid{n}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{⟦\char95 ⟧ᵃˢ}\;{}\<[8]%
\>[8]{}\mathbin{:}\;\Conid{ArgsD}\;\Conid{Ξ}\;{}\<[19]%
\>[19]{}\Varid{→}\;\Conid{Fam}\;\Varid{→}\;\Conid{Fam}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Varid{[]}\;{}\<[17]%
\>[17]{}\Varid{⟧ᵃˢ}\;{}\<[22]%
\>[22]{}\anonymous \;\anonymous \;{}\<[27]%
\>[27]{}\mathrel{=}\;\Varid{⊤}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;(\Conid{Δ}\;\Varid{⊢}\;\Conid{A})\;\Varid{∷}\;\Conid{Ds}\;{}\<[17]%
\>[17]{}\Varid{⟧ᵃˢ}\;{}\<[22]%
\>[22]{}\Conid{X}\;\Varid{n}\;{}\<[27]%
\>[27]{}\mathrel{=}\;{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{⟦}\;\Conid{Δ}\;\Varid{⟧ᵃ}\;\Conid{X}\;\Varid{n}\;\Varid{×}\;\Varid{⟦}\;\Conid{Ds}\;\Varid{⟧ᵃˢ}\;\Conid{X}\;\Varid{n}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
\end{minipage}
\begin{minipage}[t]{.3\textwidth}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{10}{@{}>{\hspre}l<{\hspost}@{}}%
\column{11}{@{}>{\hspre}l<{\hspost}@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{16}{@{}>{\hspre}l<{\hspost}@{}}%
\column{20}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{⟦\char95 ⟧ᶜ}\;{}\<[8]%
\>[8]{}\mathbin{:}\;\Conid{OpD}\;{}\<[15]%
\>[15]{}\Varid{→}\;\Conid{Fam}\;\Varid{→}\;\Conid{Fam}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Varid{ι}\;\Conid{Ds}\;\anonymous \;{}\<[11]%
\>[11]{}\Varid{⟧ᶜ}\;{}\<[15]%
\>[15]{}\Conid{X}\;{}\<[20]%
\>[20]{}\mathrel{=}\;\Varid{⟦}\;\Conid{Ds}\;\Varid{⟧ᵃˢ}\;\Conid{X}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\Varid{⟦\char95 ⟧}\;{}\<[8]%
\>[8]{}\mathbin{:}\;\Conid{SigD}\;{}\<[16]%
\>[16]{}\Varid{→}\;\Conid{Fam}\;\Varid{→}\;\Conid{Fam}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Conid{D}\;{}\<[10]%
\>[10]{}\Varid{⟧}\;{}\<[15]%
\>[15]{}\Conid{X}\;\Varid{n}\;{}\<[20]%
\>[20]{}\mathrel{=}\;{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Conid{Σ[}\;\Varid{i}\;\Varid{∈}\;\Conid{D}\;\Varid{.Op}\;\mskip1.5mu]\;\Varid{⟦}\;\Conid{D}\;\Varid{.ar}\;\Varid{i}\;\Varid{⟧ᶜ}\;\Conid{X}\;\Varid{n}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
\end{minipage}
\begin{minipage}[t]{.33\textwidth}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{23}{@{}>{\hspre}l<{\hspost}@{}}%
\column{33}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Conid{Raw}\;\mathbin{:}\;\Conid{ℕ}\;\Varid{→}\;\Conid{Set}\;\Keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\text{\textasciigrave}\anonymous \;{}\<[8]%
\>[8]{}\mathbin{:}\;\Conid{Fin}\;\Varid{n}\;{}\<[33]%
\>[33]{}\Varid{→}\;\Conid{Raw}\;\Varid{n}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{\char95 ∋\char95 }\;{}\<[8]%
\>[8]{}\mathbin{:}\;\Conid{Ty}\;{}\<[23]%
\>[23]{}\Varid{→}\;\Conid{Raw}\;\Varid{n}\;{}\<[33]%
\>[33]{}\Varid{→}\;\Conid{Raw}\;\Varid{n}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{op}\;{}\<[8]%
\>[8]{}\mathbin{:}\;\Varid{⟦}\;\Conid{D}\;\Varid{⟧}\;\Conid{Raw}\;\Varid{n}\;{}\<[33]%
\>[33]{}\Varid{→}\;\Conid{Raw}\;\Varid{n}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
\end{minipage}
\caption{Signature functor for raw terms and raw terms in \Agda}
\label{fig:formal-raw-term-functor}
\label{fig:formal-raw-terms}
\end{figure}

The inductive type of raw terms, indexed by a list of free variables, is defined as shown in \Cref{fig:formal-raw-terms}.
This mirrors our informal definition (\Cref{fig:raw-terms}), where \ensuremath{\Conid{A}\;\Varid{∋}\;\Varid{t}} corresponds to the raw term $t \annotate A$.
These definitions align closely with those found in other referenced frameworks.

\subsection{Defining Extrinsic Bidirectional Typing Derivations}\label{subsec:formal-bidirectional-typing}
Formally defining extrinsic derivations is much trickier.
This requires defining a family of sets, indexed by context, type, mode, and notably, a raw term, involving another signature endofunctor alone with the functor used for constructing raw terms. 

We begin with the family of sets on which the functor acts.
A typing judgement $\Gamma \vdash_{\Sigma, \Omega} t :^{\dir{d}} A$ can be viewed as a predicate over raw terms with four indices: a context, a $\N$-indexed family of sets, a mode, and a type.
The type of this predicate can be generalised to a family of sets over the $\N$-indexed family of sets, as follows:
{\small
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Conid{Fam}\;\mathbin{:}\;\Conid{R.Fam}\;\Varid{→}\;\Conid{Set}\;\anonymous {}\<[E]%
\\
\>[B]{}\Conid{Fam}\;\Conid{X}\;{}\<[8]%
\>[8]{}\mathrel{=}\;(\Conid{Γ}\;\mathbin{:}\;\Conid{Cxt}\;\Varid{0})\;\Varid{→}\;\Conid{X}\;(\Varid{length}\;\Conid{Γ})\;\Varid{→}\;\Conid{Mode}\;\Varid{→}\;\Conid{Ty}\;\Varid{→}\;\Conid{Set}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
}
Observe that the second index \ensuremath{\Conid{X}} depends on the length of the first index \ensuremath{\Conid{Γ}}.
This is because a typing derivation for a raw term $V \vdash_{\Sigma, \erase{\Omega}} t$ requires the same number of variables as in $V$.

In a similar vein, we define four functors for the construction of bidirectional typing derivations, albeit in a top-down manner.
An endofunctor on predicates must act as a \emph{lifting} of the functor on its domain, illustrated by the signature endofunctor \ensuremath{\Varid{⟦\char95 ⟧}} for a bidirectional binding signature:
{\small
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{6}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{⟦\char95 ⟧}\;{}\<[6]%
\>[6]{}\mathbin{:}\;(\Conid{D}\;\mathbin{:}\;\Conid{SigD})\;(\Conid{X}\;\mathbin{:}\;\Conid{R.Fam})\;(\Conid{Y}\;\mathbin{:}\;\Conid{Fam}\;\Conid{X})\;\Varid{→}\;\Conid{Fam}\;(\Conid{R.⟦}\;\Varid{erase}\;\Conid{D}\;\Varid{⟧}\;\Conid{X}){}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Conid{D}\;\Varid{⟧}\;\Conid{X}\;\Conid{Y}\;\Conid{Γ}\;(\Varid{o}\;\Varid{,}\;\Varid{ts})\;\Varid{d}\;\Conid{A}\;\mathrel{=}\;\Varid{⟦}\;\Conid{D}\;\Varid{.ar}\;\Varid{o}\;\Varid{⟧ᶜ}\;\Conid{X}\;\Conid{Y}\;\Conid{Γ}\;\Varid{ts}\;\Varid{d}\;\Conid{A}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
}
This functor maps a predicate \ensuremath{\Conid{Y}} over \ensuremath{\Conid{X}} into a predicate \ensuremath{\Varid{⟦}\;\Conid{D}\;\Varid{⟧}\;\Conid{X}\;\Conid{Y}} over \ensuremath{\Conid{R.⟦}\;\Varid{erase}\;\Conid{D}\;\Varid{⟧}\;\Conid{X}}.
Here, \ensuremath{\Varid{erase}\;\Conid{D}} represents the mode erasure of \ensuremath{\Conid{D}}, and the prefix \ensuremath{\Conid{R}} in \ensuremath{\Conid{R.⟦\char95 ⟧}} indicates the signature endofunctor used in raw term construction.

The functor \ensuremath{\Varid{⟦}\;\Conid{D}\;\Varid{.ar}\;\Varid{o}\;\Varid{⟧ᶜ}} is defined for an operation $\biop$:
{\small\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{7}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{⟦\char95 ⟧ᶜ}\;{}\<[7]%
\>[7]{}\mathbin{:}\;(\Conid{D}\;\mathbin{:}\;\Conid{OpD})\;(\Conid{X}\;\mathbin{:}\;\Conid{R.Fam}\;\Varid{ℓ})\;(\Conid{Y}\;\mathbin{:}\;\Conid{Fam}\;\iden{\Varid{ℓ}^\prime}\;\Conid{X})\;\Varid{→}\;\Conid{Fam}\;\iden{\Varid{ℓ}^\prime}\;(\Conid{R.⟦}\;\Varid{eraseᶜ}\;\Conid{D}\;\Varid{⟧ᶜ}\;\Conid{X}){}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Varid{ι}\;\{\mskip1.5mu \Conid{Ξ}\mskip1.5mu\}\;\Varid{d}\;\Conid{A₀}\;\Conid{D}\;\Varid{⟧ᶜ}\;\Conid{X}\;\Conid{Y}\;\Conid{Γ}\;\Varid{xs}\;\Varid{d′}\;\Conid{A}\;\mathrel{=}\;{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{d}\;\Varid{≡}\;\Varid{d′}\;\Varid{×}\;\Conid{Σ[}\;\Varid{p}\;\Varid{∈}\;\Conid{TSub}\;\Conid{Ξ}\;\Varid{0}\;\mskip1.5mu]\;\Conid{A₀}\;\Varid{⟨}\;\Varid{p}\;\Varid{⟩}\;\Varid{≡}\;\Conid{A}\;\Varid{×}\;\Varid{⟦}\;\Conid{D}\;\Varid{⟧ᵃˢ}\;\Conid{X}\;\Conid{Y}\;\Varid{σ}\;\Conid{Γ}\;\Varid{xs}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
}
A set within the family is only inhabited if the indices correspond with the mode and the type as specified by the operation.
Therefore, in defining the set \ensuremath{\Varid{⟦}\;\Varid{ι}\;\{\mskip1.5mu \Conid{Ξ}\mskip1.5mu\}\;\Varid{d}\;\Conid{A₀}\;\Conid{D}\;\Varid{⟧ᶜ}\;\Conid{X}\;\Conid{Y}\;\Conid{Γ}\;\Varid{xs}\;\Varid{d′}\;\Conid{A}}, it takes identity proofs for \ensuremath{\Varid{d}\;\Varid{≡}\;\Varid{d′}} and \ensuremath{\Conid{A₀}\;\Varid{⟨}\;\Varid{σ}\;\Varid{⟩}\;\Varid{≡}\;\Conid{A}}, with \ensuremath{\Conid{A₀}} instantiated by a substitution \ensuremath{\Varid{σ}} from $\Xi$ to $\emptyset$.
This ensures that the set is inhabited only if the indices align with what the arity (\ensuremath{\Conid{D}\;\Varid{.ar}\;\Varid{o}}) specifies.

The signature endofunctor for an argument list \ensuremath{\Conid{Ds}} is defined in a manner that it maps a predicate to a family of sets indexed by a context and a family of product sets, considering that each premise in a typing derivation shares a common context $\Gamma$ and a term from a list of subterms.
{\small\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{20}{@{}>{\hspre}l<{\hspost}@{}}%
\column{27}{@{}>{\hspre}l<{\hspost}@{}}%
\column{30}{@{}>{\hspre}l<{\hspost}@{}}%
\column{33}{@{}>{\hspre}l<{\hspost}@{}}%
\column{36}{@{}>{\hspre}l<{\hspost}@{}}%
\column{46}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{⟦\char95 ⟧ᵃˢ}\;{}\<[8]%
\>[8]{}\mathbin{:}\;(\Conid{D}\;\mathbin{:}\;\Conid{ArgsD}\;\Conid{Ξ})\;(\Conid{X}\;\mathbin{:}\;\Conid{R.Fam})\;(\Conid{Y}\;\mathbin{:}\;\Conid{Fam}\;\Conid{X})\;{}\<[E]%
\\
\>[8]{}\Varid{→}\;\Conid{TSub}\;\Conid{Ξ}\;\Varid{0}\;\Varid{→}\;(\Conid{Γ}\;\mathbin{:}\;\Conid{Cxt}\;\Varid{0})\;\Varid{→}\;\Conid{R.⟦}\;\Varid{eraseᵃˢ}\;\Conid{D}\;\Varid{⟧ᵃˢ}\;\Conid{X}\;(\Varid{length}\;\Conid{Γ})\;\Varid{→}\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Varid{[]}\;{}\<[20]%
\>[20]{}\Varid{⟧ᵃˢ}\;\anonymous \;{}\<[27]%
\>[27]{}\anonymous \;{}\<[30]%
\>[30]{}\anonymous \;{}\<[33]%
\>[33]{}\anonymous \;{}\<[36]%
\>[36]{}\anonymous \;{}\<[46]%
\>[46]{}\mathrel{=}\;\Varid{⊤}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Conid{Δ}\;\Varid{⊢[}\;\Varid{d}\;\mskip1.5mu]\;\Conid{A}\;\Varid{∷}\;\Conid{Ds}\;{}\<[20]%
\>[20]{}\Varid{⟧ᵃˢ}\;\Conid{X}\;{}\<[27]%
\>[27]{}\Conid{Y}\;{}\<[30]%
\>[30]{}\Varid{σ}\;{}\<[33]%
\>[33]{}\Conid{Γ}\;{}\<[36]%
\>[36]{}(\Varid{x}\;\Varid{,}\;\Varid{xs})\;{}\<[46]%
\>[46]{}\mathrel{=}\;{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{⟦}\;\Conid{Δ}\;\Varid{⟧ᵃ}\;\Conid{X}\;(\Varid{λ}\;\iden{\Conid{Γ}^\prime}\;\iden{\Varid{x}^\prime}\;\Varid{→}\;\Conid{Y}\;\iden{\Conid{Γ}^\prime}\;\iden{\Varid{x}^\prime}\;\Varid{d}\;(\Conid{A}\;\Varid{⟨}\;\Varid{σ}\;\Varid{⟩}))\;\Varid{σ}\;\Conid{Γ}\;\Varid{x}\;\Varid{×}\;\Varid{⟦}\;\Conid{Ds}\;\Varid{⟧ᵃˢ}\;\Conid{X}\;\Conid{Y}\;\Varid{σ}\;\Conid{Γ}\;\Varid{xs}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
}
The signature endofunctor \ensuremath{\Varid{⟦}\;\Conid{Δ}\;\Varid{⟧ᵃ}} for an extension context \ensuremath{\Conid{Δ}} maps a predicate $Y$ over a $\N$-indexed family $X$ of sets into a predicate (\ensuremath{\Varid{⟦}\;\Conid{Δ}\;\Varid{⟧ᵃ}\;\Conid{X}\;\Conid{Y}}) whose context is extended by the types in \ensuremath{\Conid{Δ}}.
{\small\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{7}{@{}>{\hspre}l<{\hspost}@{}}%
\column{10}{@{}>{\hspre}l<{\hspost}@{}}%
\column{24}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Varid{⟦\char95 ⟧ᵃ}\;{}\<[7]%
\>[7]{}\mathbin{:}\;(\Conid{Δ}\;\mathbin{:}\;\Conid{Cxt}\;\Conid{Ξ})\;(\Conid{X}\;\mathbin{:}\;\Conid{R.Fam})\;(\Conid{Y}\;\mathbin{:}\;(\Conid{Γ}\;\mathbin{:}\;\Conid{Cxt}\;\Varid{0})\;\Varid{→}\;\Conid{X}\;(\Varid{length}\;\Conid{Γ})\;\Varid{→}\;\Conid{Set})\;{}\<[E]%
\\
\>[7]{}\Varid{→}\;\Conid{TSub}\;\Conid{Ξ}\;\Varid{0}\;\Varid{→}\;(\Conid{Γ}\;\mathbin{:}\;\Conid{Cxt}\;\Varid{0})\;\Varid{→}\;\Conid{R.⟦}\;\Conid{Δ}\;\Varid{⟧ᵃ}\;\Conid{X}\;(\Varid{length}\;\Conid{Γ})\;\Varid{→}\;\Conid{Set}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Varid{[]}\;{}\<[10]%
\>[10]{}\Varid{⟧ᵃ}\;\Conid{X}\;\Conid{Y}\;\Varid{σ}\;\Conid{Γ}\;\Varid{t}\;{}\<[24]%
\>[24]{}\mathrel{=}\;\Conid{Y}\;\Conid{Γ}\;\Varid{t}{}\<[E]%
\\
\>[B]{}\Varid{⟦}\;\Conid{A}\;\Varid{∷}\;\Conid{Δ}\;{}\<[10]%
\>[10]{}\Varid{⟧ᵃ}\;\Conid{X}\;\Conid{Y}\;\Varid{σ}\;\Conid{Γ}\;\Varid{t}\;{}\<[24]%
\>[24]{}\mathrel{=}\;\Varid{⟦}\;\Conid{Δ}\;\Varid{⟧ᵃ}\;\Conid{X}\;\Conid{Y}\;\Varid{σ}\;((\Conid{A}\;\Varid{⟨}\;\Varid{σ}\;\Varid{⟩})\;\Varid{∷}\;\Conid{Γ})\;\Varid{t}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
}
This completes our definition of the signature functor for constructing extrinsic typing derivations.

At last, we can define the type of bidirectional typing derivations for a signature \ensuremath{\Conid{D}}, similarly to how we have defined simple types and raw terms.
This involves the following four constructors, corresponding to rules $\SynRule{Var}$, $\SynRule{Anno}$, $\ChkRule{Sub}$, and $\Rule{Op}$ in \Cref{fig:extrinsic-typing}.
{\small\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{9}{@{}>{\hspre}l<{\hspost}@{}}%
\column{15}{@{}>{\hspre}l<{\hspost}@{}}%
\column{24}{@{}>{\hspre}l<{\hspost}@{}}%
\column{32}{@{}>{\hspre}l<{\hspost}@{}}%
\column{56}{@{}>{\hspre}l<{\hspost}@{}}%
\column{62}{@{}>{\hspre}l<{\hspost}@{}}%
\column{71}{@{}>{\hspre}l<{\hspost}@{}}%
\column{85}{@{}>{\hspre}l<{\hspost}@{}}%
\column{89}{@{}>{\hspre}l<{\hspost}@{}}%
\column{108}{@{}>{\hspre}l<{\hspost}@{}}%
\column{113}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{data}\;\Varid{\char95 ⊢\char95 [\char95 ]\char95 }\;\mathbin{:}\;\Conid{Fam}\;\Conid{Raw}\;\Keyword{where}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{var}\;{}\<[9]%
\>[9]{}\mathbin{:}\;(\Varid{i}\;\mathbin{:}\;\Conid{A}\;\Varid{∈}\;\Conid{Γ})\;{}\<[32]%
\>[32]{}\hspace{10em}{}\<[56]%
\>[56]{}\Varid{\char95 ↑\char95 }\;{}\<[62]%
\>[62]{}\mathbin{:}\;\Conid{Γ}\;\Varid{⊢}\;\Varid{r}\;{}\<[71]%
\>[71]{}\Varid{⇒}\;\Conid{B}\;{}\<[E]%
\\
\>[9]{}\Varid{→}\;\Conid{L.index}\;\Varid{i}\;\Varid{≡}\;\Varid{j}\;{}\<[62]%
\>[62]{}\Varid{→}\;\Conid{A}\;\Varid{≡}\;\Conid{B}\;{}\<[E]%
\\
\>[9]{}\Varid{→}\;\Conid{Γ}\;\Varid{⊢}\;(\text{\textasciigrave}\;\Varid{j})\;\Varid{⇒}\;\Conid{A}\;{}\<[62]%
\>[62]{}\Varid{→}\;\Conid{Γ}\;\Varid{⊢}\;\Varid{r}\;{}\<[71]%
\>[71]{}\Varid{⇐}\;\Conid{A}\;{}\<[E]%
\\[\blanklineskip]%
\>[9]{}\Varid{\char95 ∋\char95 }\;{}\<[15]%
\>[15]{}\mathbin{:}\;(\Conid{A}\;\mathbin{:}\;\Conid{Ty})\;{}\<[56]%
\>[56]{}\Varid{op}\;{}\<[62]%
\>[62]{}\mathbin{:}\;\Varid{⟦}\;\Conid{D}\;\Varid{⟧}\;\Conid{Raw}\;\Varid{\char95 ⊢\char95 [\char95 ]\char95 }\;\Conid{Γ}\;{}\<[85]%
\>[85]{}\Varid{rs}\;{}\<[89]%
\>[89]{}\phantom{[}{}\<[108]%
\>[108]{}\Varid{d}\;{}\<[113]%
\>[113]{}\Conid{A}\;{}\<[E]%
\\
\>[9]{}\Varid{→}\;\Conid{Γ}\;\Varid{⊢}\;\Varid{r}\;{}\<[24]%
\>[24]{}\Varid{⇐}\;\Conid{A}\;{}\<[62]%
\>[62]{}\Varid{→}\;\Conid{Γ}\;\Varid{⊢}\;\Varid{op}\;\Varid{rs}\;{}\<[89]%
\>[89]{}[\mskip1.5mu \;{}\<[108]%
\>[108]{}\Varid{d}\;\mskip1.5mu]\;{}\<[113]%
\>[113]{}\Conid{A}\;{}\<[E]%
\\
\>[9]{}\Varid{→}\;\Conid{Γ}\;\Varid{⊢}\;(\Conid{A}\;\Varid{∋}\;\Varid{r})\;{}\<[24]%
\>[24]{}\Varid{⇒}\;\Conid{A}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
}

\subsection{A Formal Proof Example: Soundness}\label{subsec:formal-proofs}

Induction proofs in our formalisation typically consist of three mutual definitions---one for the inductive type of derivations, one for a list of arguments, and one for an extension context.

As an illustration, consider the formal proof of soundness below, i.e.\ the `if' part of \cref{lem:soundness-completeness}.
Its formal proof is defined in a module which has signatures as its parameters:
{\small\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{module}\;\Conid{Theory.Soundness}\;\{\mskip1.5mu \Conid{SD}\;\mathbin{:}\;\Conid{S.SigD}\mskip1.5mu\}\;(\Conid{BD}\;\mathbin{:}\;\Conid{B.SigD}\;\Conid{SD})\;\Keyword{where}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
}
Then, the induction proof is nothing more than a function defined by pattern matching for each case: each constructor of bidirectional typing derivations is mapped to a corresponding constructor of typing derivations.
(The definition \ensuremath{\Varid{soundnessᵃ}} might be further removed if \Agda's termination checker 
The only (slightly) interesting case $\ChkRule{Sub}$ is proved by disregarding the identity proof \ensuremath{\Varid{refl}} and use the induction hypothesis (\ensuremath{\Varid{soundness}\;\Varid{t}}) directly:
\begin{figure}[H]
  \codefigure
  \begin{minipage}[t]{.55\textwidth}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{24}{@{}>{\hspre}l<{\hspost}@{}}%
\column{28}{@{}>{\hspre}l<{\hspost}@{}}%
\column{30}{@{}>{\hspre}l<{\hspost}@{}}%
\column{33}{@{}>{\hspre}l<{\hspost}@{}}%
\column{35}{@{}>{\hspre}l<{\hspost}@{}}%
\column{41}{@{}>{\hspre}l<{\hspost}@{}}%
\column{45}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\Keyword{mutual}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{soundness}\;\mathbin{:}\;\Conid{Γ}\;\Varid{⊢}\;\Varid{r}\;[\mskip1.5mu \;\Varid{d}\;\mskip1.5mu]\;\Conid{A}\;{}\<[30]%
\>[30]{}\Varid{→}\;{}\<[33]%
\>[33]{}\Conid{Γ}\;\Varid{⊢}\;\Varid{r}\;\Varid{⦂}\;\Conid{A}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{soundness}\;(\Varid{var}\;\Varid{i}\;\Varid{eq})\;\mathrel{=}\;\Varid{var}\;\Varid{i}\;\Varid{eq}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{soundness}\;(\Conid{A}\;\Varid{∋}\;\Varid{t})\;{}\<[24]%
\>[24]{}\mathrel{=}\;\Conid{A}\;\Varid{∋}\;\Varid{soundness}\;\Varid{t}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{soundness}\;(\Varid{t}\;\Varid{↑}\;\Varid{refl})\;\mathrel{=}\;\Varid{soundness}\;\Varid{t}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{soundness}\;(\Varid{op}\;\{\mskip1.5mu \Varid{rs}\;\mathrel{=}\;\Varid{i}\;\Varid{,}\;\anonymous \mskip1.5mu\}\;(\anonymous \;\Varid{,}\;\Varid{σ}\;\Varid{,}\;\Varid{σ-eq}\;\Varid{,}\;\Varid{ts}))\;\mathrel{=}\;{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{op}\;(\Varid{σ}\;\Varid{,}\;\Varid{σ-eq}\;\Varid{,}\;\Varid{soundnessᵃˢ}\;(\Conid{BD}\;\Varid{.ar}\;\Varid{i}\;\Varid{.args})\;\Varid{ts}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{soundnessᵃˢ}\;{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\mathbin{:}\;{}\<[8]%
\>[8]{}(\Conid{Ds}\;\mathbin{:}\;\Conid{ArgsD}\;\Conid{Ξ})\;{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{→}\;{}\<[8]%
\>[8]{}\Varid{⟦}\;\Conid{Ds}\;\Varid{⟧ᵃˢ}\;{}\<[28]%
\>[28]{}\Conid{Raw}\;\Varid{\char95 ⊢\char95 [\char95 ]\char95 }\;{}\<[41]%
\>[41]{}\Varid{σ}\;\Conid{Γ}\;\Varid{rs}\;{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{→}\;{}\<[8]%
\>[8]{}\Conid{T.⟦}\;\Varid{eraseᵃˢ}\;\Conid{Ds}\;\Varid{⟧ᵃˢ}\;{}\<[28]%
\>[28]{}\Conid{Raw}\;\Varid{\char95 ⊢\char95 ⦂\char95 }\;{}\<[41]%
\>[41]{}\Varid{σ}\;\Conid{Γ}\;\Varid{rs}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{soundnessᵃˢ}\;\Varid{[]}\;{}\<[35]%
\>[35]{}\anonymous \;{}\<[45]%
\>[45]{}\mathrel{=}\;\Varid{tt}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\Varid{soundnessᵃˢ}\;((\Conid{Δ}\;\Varid{⊢[}\;\anonymous \;\mskip1.5mu]\;\anonymous )\;\Varid{∷}\;\Conid{Ds})\;(\Varid{t}\;\Varid{,}\;\Varid{ts})\;{}\<[45]%
\>[45]{}\mathrel{=}\;{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{soundnessᵃ}\;\Conid{Δ}\;\Varid{t}\;\Varid{,}\;\Varid{soundnessᵃˢ}\;\Conid{Ds}\;\Varid{ts}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
\end{minipage}
\begin{minipage}[t]{.44\textwidth}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{8}{@{}>{\hspre}l<{\hspost}@{}}%
\column{18}{@{}>{\hspre}l<{\hspost}@{}}%
\column{23}{@{}>{\hspre}l<{\hspost}@{}}%
\column{26}{@{}>{\hspre}l<{\hspost}@{}}%
\column{29}{@{}>{\hspre}l<{\hspost}@{}}%
\column{34}{@{}>{\hspre}l<{\hspost}@{}}%
\column{38}{@{}>{\hspre}l<{\hspost}@{}}%
\column{41}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[3]{} \phantom{mutual} {}\<[E]%
\\
\>[3]{}\Varid{soundnessᵃ}\;{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\mathbin{:}\;{}\<[8]%
\>[8]{}(\Conid{Δ}\;\mathbin{:}\;\Conid{TExps}\;\Conid{Ξ})\;{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{→}\;{}\<[8]%
\>[8]{}\Varid{⟦}\;\Conid{Δ}\;\Varid{⟧ᵃ}\;{}\<[18]%
\>[18]{}\Conid{Raw}\;(\Varid{\char95 ⊢\char95 [}\;{}\<[29]%
\>[29]{}\Varid{d}\;\mskip1.5mu]\;{}\<[34]%
\>[34]{}\Conid{A})\;{}\<[38]%
\>[38]{}\Varid{σ}\;\Conid{Γ}\;\Varid{r}\;{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\Varid{→}\;{}\<[8]%
\>[8]{}\Conid{T.⟦}\;\Conid{Δ}\;\Varid{⟧ᵃ}\;{}\<[18]%
\>[18]{}\Conid{Raw}\;(\Varid{\char95 ⊢\char95 ⦂}\;{}\<[34]%
\>[34]{}\Conid{A})\;{}\<[38]%
\>[38]{}\Varid{σ}\;\Conid{Γ}\;\Varid{r}{}\<[E]%
\\
\>[3]{}\Varid{soundnessᵃ}\;\Varid{[]}\;{}\<[23]%
\>[23]{}\Varid{t}\;{}\<[26]%
\>[26]{}\mathrel{=}\;\Varid{soundness}\;{}\<[41]%
\>[41]{}\Varid{t}{}\<[E]%
\\
\>[3]{}\Varid{soundnessᵃ}\;(\anonymous \;\Varid{∷}\;\Conid{Δ})\;{}\<[23]%
\>[23]{}\Varid{t}\;{}\<[26]%
\>[26]{}\mathrel{=}\;\Varid{soundnessᵃ}\;\Conid{Δ}\;\Varid{t}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
\end{minipage}
%\caption{The soundness proof in \Agda}
%\label{fig:formal-soundness}
\end{figure}
Compared to an induction proof tailored for a specific system, the size of a generic induction proof remains the same, regardless of the signature.
This makes it manageable even in a proof assistant like \Agda, which lacks extensive tactics for automating theorem proving.
Hence, we achieve more by doing less.
\end{document}
